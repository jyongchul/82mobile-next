---
wave: 1
depends_on: []
files_modified:
  - .htaccess
  - /mnt/c/82Mobile/82mobile-next/scripts/verify_cache_bypass.py
  - /mnt/c/82Mobile/82mobile-next/.planning/phases/02-infrastructure-caching/CACHE-VERIFICATION-REPORT.md
autonomous: true
---

# Plan 02-01: Cache Verification & Monitoring Setup

## Objective

Verify Phase 1 .htaccess cache bypass is working and implement automated 48-hour monitoring to confirm Gabia server cache no longer interferes with `/wp-json/*` API endpoints.

## Context

Phase 1 deployed .htaccess cache exclusion rules for `/wp-json/*` paths, but Gabia hosting has extreme server-level caching (24-48 hour TTL). This plan verifies the cache bypass is working and sets up automated monitoring to track cache behavior over 48 hours.

**Key constraint**: Cannot assume .htaccess changes are active yet due to Gabia cache propagation delay.

## Tasks

<task id="1" title="Verify Phase 1 .htaccess cache rules">

**Goal**: Confirm .htaccess cache bypass rules from Phase 1 are still present and correctly positioned.

**Steps**:
1. Download current .htaccess file via FTP from `/` (WordPress root)
2. Verify cache bypass rules exist:
   ```apache
   # API Cache Bypass
   <IfModule mod_headers.c>
   <FilesMatch "\.(json)$">
     Header set Cache-Control "no-cache, no-store, must-revalidate"
     Header set Pragma "no-cache"
     Header set Expires 0
   </FilesMatch>
   </IfModule>

   <IfModule mod_rewrite.c>
   RewriteCond %{REQUEST_URI} ^/wp-json/ [NC]
   RewriteRule .* - [E=no-cache:1]
   Header set Cache-Control "no-cache, no-store, must-revalidate" env=no-cache
   </IfModule>
   ```
3. Verify rules are positioned OUTSIDE WordPress markers (before `# BEGIN WordPress` or after `# END WordPress`)
4. If missing or incorrectly positioned: Re-deploy via FTP with correct placement
5. Document current .htaccess state in verification report

**Verification**:
- [ ] .htaccess file downloaded successfully
- [ ] Cache bypass rules present
- [ ] Rules positioned outside WordPress markers (won't be overwritten)
- [ ] If re-deployed: FTP upload successful

**Files modified**: `.htaccess` (if re-deployment needed)

</task>

<task id="2" title="Create cache verification script">

**Goal**: Build Python script to test API cache bypass using both header inspection and timestamp freshness checks.

**Steps**:
1. Create `/mnt/c/82Mobile/82mobile-next/scripts/verify_cache_bypass.py`
2. Implement dual verification methods:

   **Method 1: HTTP Header Verification**
   ```python
   import requests

   def verify_cache_headers():
       url = "http://82mobile.com/wp-json/wc/v3/products"
       response = requests.get(url, auth=("ck_...", "cs_..."))

       # Check for cache bypass headers
       cache_control = response.headers.get('Cache-Control', '')
       pragma = response.headers.get('Pragma', '')

       checks = {
           'no-cache in Cache-Control': 'no-cache' in cache_control,
           'no-store in Cache-Control': 'no-store' in cache_control,
           'must-revalidate in Cache-Control': 'must-revalidate' in cache_control,
           'Pragma: no-cache': pragma == 'no-cache'
       }

       return checks
   ```

   **Method 2: Timestamp Freshness Test**
   ```python
   def verify_timestamp_freshness():
       # Get product via API
       response1 = requests.get(api_url)
       product = response1.json()[0]
       api_modified = product['date_modified']

       # Update product in WooCommerce (via API)
       import time
       time.sleep(2)
       requests.put(api_url + f"/{product['id']}",
                    json={'description': f'Updated {time.time()}'})

       # Query again immediately
       response2 = requests.get(api_url)
       product_updated = response2.json()[0]
       api_modified_new = product_updated['date_modified']

       # If cached, timestamps will be identical
       return api_modified != api_modified_new
   ```

3. Add CLI arguments for scheduled monitoring:
   - `--interval`: Test interval (0h, 1h, 6h, 24h, 48h)
   - `--report`: Path to cumulative report file
   - `--silent`: Suppress output (for cron jobs)

4. Output JSON report with timestamp, test results, pass/fail status

**Verification**:
- [ ] Script created at correct path
- [ ] Both verification methods implemented
- [ ] CLI arguments working
- [ ] JSON output format correct
- [ ] Script executable: `python3 scripts/verify_cache_bypass.py --interval 0h`

**Files created**: `scripts/verify_cache_bypass.py`

</task>

<task id="3" title="Run initial cache verification test">

**Goal**: Execute first verification test (0-hour baseline) and document results.

**Steps**:
1. Run verification script: `python3 scripts/verify_cache_bypass.py --interval 0h --report .planning/phases/02-infrastructure-caching/CACHE-VERIFICATION-REPORT.md`
2. Review results:
   - If PASS (both methods): Cache bypass working
   - If FAIL (headers missing): Gabia cache not cleared yet (expected, document in report)
   - If FAIL (timestamp stale): Cache still active (expected, continue monitoring)
3. Document baseline results in CACHE-VERIFICATION-REPORT.md:
   - Timestamp of test
   - HTTP headers received
   - Timestamp freshness result
   - Overall status (PASS/FAIL)
   - Expected behavior: May fail initially due to 24-48h propagation delay

**Verification**:
- [ ] Script executed successfully
- [ ] Report file created
- [ ] Baseline results documented
- [ ] Status documented (PASS or expected FAIL)

**Files created**: `.planning/phases/02-infrastructure-caching/CACHE-VERIFICATION-REPORT.md`

</task>

<task id="4" title="Schedule 48-hour monitoring">

**Goal**: Set up automated cache verification tests at 1h, 6h, 24h, 48h intervals.

**Steps**:
1. Create monitoring schedule script `scripts/schedule_cache_monitoring.sh`:
   ```bash
   #!/bin/bash
   # Run at 1h, 6h, 24h, 48h after initial test

   SCRIPT_DIR="/mnt/c/82Mobile/82mobile-next"
   REPORT=".planning/phases/02-infrastructure-caching/CACHE-VERIFICATION-REPORT.md"

   # 1 hour
   sleep 3600
   python3 $SCRIPT_DIR/scripts/verify_cache_bypass.py --interval 1h --report $REPORT

   # 6 hours (5 more hours)
   sleep 18000
   python3 $SCRIPT_DIR/scripts/verify_cache_bypass.py --interval 6h --report $REPORT

   # 24 hours (18 more hours)
   sleep 64800
   python3 $SCRIPT_DIR/scripts/verify_cache_bypass.py --interval 24h --report $REPORT

   # 48 hours (24 more hours)
   sleep 86400
   python3 $SCRIPT_DIR/scripts/verify_cache_bypass.py --interval 48h --report $REPORT
   ```

2. Start monitoring in background: `nohup bash scripts/schedule_cache_monitoring.sh > /tmp/cache_monitor.log 2>&1 &`
3. Document monitoring schedule in report
4. Add instructions for checking results:
   - `cat .planning/phases/02-infrastructure-caching/CACHE-VERIFICATION-REPORT.md`
   - `tail -f /tmp/cache_monitor.log` (live monitoring)

**Verification**:
- [ ] Schedule script created
- [ ] Monitoring started in background
- [ ] Schedule documented in report
- [ ] Instructions for result checking added

**Files created**: `scripts/schedule_cache_monitoring.sh`

**Note**: Monitoring runs asynchronously. Results accumulate in CACHE-VERIFICATION-REPORT.md over 48 hours. Phase can continue to other plans while monitoring proceeds.

</task>

## Must-Haves (Goal-Backward Verification)

When this plan completes, these must be TRUE:

1. **Cache bypass rules verified**: Phase 1 .htaccess rules confirmed present and correctly positioned (outside WordPress markers)

2. **Verification script operational**: `scripts/verify_cache_bypass.py` exists and successfully runs both header and timestamp checks

3. **Baseline test executed**: Initial (0-hour) verification test completed with results documented in CACHE-VERIFICATION-REPORT.md

4. **Monitoring scheduled**: 48-hour monitoring initiated in background with tests scheduled at 1h, 6h, 24h, 48h intervals

5. **Report initialized**: CACHE-VERIFICATION-REPORT.md exists with baseline results and monitoring schedule documented

**Success means**: We have objective evidence of whether Gabia cache bypass is working, with automated monitoring to track cache behavior over 48-hour propagation window.

## Dependencies

**Requires**:
- Phase 1 complete (.htaccess cache bypass deployed)
- FTP access to Gabia hosting
- WooCommerce API credentials

**Enables**:
- Plan 02-02 (can start immediately, monitoring runs in parallel)
- Plan 02-03 (can start immediately)
- Objective data on cache bypass effectiveness for Phase 3 planning

## Notes

- Monitoring runs asynchronously; don't block on results
- Expected behavior: Initial tests may FAIL due to 24-48h Gabia cache propagation
- By 48-hour mark, should see PASS if .htaccess rules are effective
- If still FAIL at 48h: Escalate to Gabia support for manual cache exclusion

## Estimated Duration

30 minutes (excluding 48-hour monitoring window)
