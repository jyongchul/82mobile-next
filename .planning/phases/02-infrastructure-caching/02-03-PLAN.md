---
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - /mnt/c/82Mobile/82mobile-next/.planning/phases/02-infrastructure-caching/DNS-CUTOVER-PLAN.md
  - /mnt/c/82Mobile/82mobile-next/scripts/cloudflare_dns_manager.py
  - /mnt/c/82Mobile/82mobile-next/vercel.json
autonomous: false
checkpoints:
  - id: dns_strategy_approval
    type: verification
    prompt: "DNS cutover plan created. Review DNS-CUTOVER-PLAN.md for immediate cutover strategy (no subdomain). Approve to continue?"
---

# Plan 02-03: DNS Cutover Strategy & Vercel Configuration

## Objective

Document DNS cutover strategy for immediate production deployment (no subdomain testing), configure Vercel rewrites for WordPress admin proxying, and prepare Cloudflare DNS automation for cutover execution.

## Context

User explicitly rejected subdomain testing approach ("Î∞îÎ°ú Ï†ÑÌôò" - immediate cutover). This plan creates production-ready DNS strategy with:
- Vercel rewrites for /wp-admin proxying (transparent to user)
- Cloudflare DNS automation (300s TTL for fast rollback)
- Pre-cutover verification requirements (Vercel preview domain testing)
- Manual rollback procedures

**Critical constraint**: No new.82mobile.com subdomain. Direct 82mobile.com ‚Üí Vercel cutover.

## Tasks

<task id="1" title="Create DNS cutover plan document">

**Goal**: Comprehensive DNS strategy document with immediate cutover approach, rollback procedures, and health check requirements.

**Steps**:
1. Create `.planning/phases/02-infrastructure-caching/DNS-CUTOVER-PLAN.md`
2. Document immediate cutover strategy:

```markdown
# DNS Cutover Plan: Immediate Production Deployment

**Strategy**: Immediate DNS cutover (no subdomain testing phase)
**Target**: 82mobile.com ‚Üí Vercel Next.js frontend
**WordPress Admin**: Proxied via Vercel rewrites to Gabia hosting
**DNS Management**: Cloudflare
**TTL**: 300 seconds (5-minute rollback window)

## Pre-Cutover Requirements

**MANDATORY** - Must be TRUE before DNS cutover:

1. ‚úÖ **Phase 1 Complete**: WordPress API accessible, CORS configured, CoCart working
2. ‚úÖ **Phase 2 Cache Verified**: 48-hour monitoring confirms cache bypass working (Plan 02-01)
3. ‚è≥ **Phase 3 Complete**: Next.js API routes operational, environment variables configured
4. ‚è≥ **Phase 4 Complete**: Cart functionality working with CoCart integration
5. ‚è≥ **Phase 5 Complete**: Product catalog, checkout flow, multilingual UI operational
6. ‚è≥ **Phase 6 Complete**: Payment gateway integrated and tested in sandbox
7. ‚è≥ **Vercel Preview Verified**: Full e-commerce flow tested on Vercel preview domain (products, cart, checkout, payment)

**Pre-cutover testing checklist** (Vercel preview domain):
- [ ] Homepage loads
- [ ] Product listing page works (API call to WordPress)
- [ ] Product detail page works
- [ ] Add to cart works (CoCart API call)
- [ ] Cart drawer displays items
- [ ] Checkout form works
- [ ] Payment modal opens (sandbox)
- [ ] WordPress admin accessible via preview URL /wp-admin (rewrite proxy test)
- [ ] No CORS errors in browser console
- [ ] All API endpoints return fresh data

## DNS Configuration

**Current State** (before cutover):
- A record: 82mobile.com ‚Üí Gabia IP (xxx.xxx.xxx.xxx)
- CNAME: www.82mobile.com ‚Üí 82mobile.com
- MX records: Preserved (email)
- TTL: Default (3600s or higher)

**Target State** (after cutover):
- A record: 82mobile.com ‚Üí Vercel IP (76.76.21.21)
- CNAME: www.82mobile.com ‚Üí cname.vercel-dns.com
- MX records: UNCHANGED (email routing preserved)
- TTL: 300s (set 72 hours before cutover for propagation)

**Cloudflare Settings**:
- SSL/TLS Mode: Full (Vercel provides SSL certificate)
- Proxy Status: DNS only (gray cloud, not orange) - **CRITICAL for Vercel SSL**
- Always Use HTTPS: Enabled
- Automatic HTTPS Rewrites: Enabled

## Vercel Rewrites Configuration

Transparent proxy for WordPress admin access:

```json
{
  "rewrites": [
    {
      "source": "/wp-admin",
      "destination": "http://82mobile.com/wp-admin"
    },
    {
      "source": "/wp-admin/:path*",
      "destination": "http://82mobile.com/wp-admin/:path*"
    },
    {
      "source": "/wp-login.php",
      "destination": "http://82mobile.com/wp-login.php"
    },
    {
      "source": "/wp-includes/:path*",
      "destination": "http://82mobile.com/wp-includes/:path*"
    },
    {
      "source": "/wp-content/:path*",
      "destination": "http://82mobile.com/wp-content/:path*"
    }
  ]
}
```

**How it works**:
- User visits: https://82mobile.com/wp-admin
- Vercel receives request, proxies to Gabia WordPress
- Response returned through Vercel
- URL stays 82mobile.com/wp-admin (transparent to user)
- Cookies, authentication headers passed through automatically

## Cutover Execution Steps

**72 hours before cutover**:
1. Lower Cloudflare DNS TTL to 300s for all 82mobile.com records
2. Wait for TTL propagation (existing 3600s TTL must expire)

**Cutover day** (recommended: 3-5 AM Korea Time, low traffic):
1. Final verification on Vercel preview domain (30 min)
2. Announce maintenance window (if needed, or silent cutover)
3. Change Cloudflare DNS via automation script:
   - A record: 82mobile.com ‚Üí 76.76.21.21 (Vercel)
   - CNAME: www.82mobile.com ‚Üí cname.vercel-dns.com
4. Monitor DNS propagation: `dig 82mobile.com` (should show Vercel IP within 5-10 min)
5. Test immediately:
   - Visit https://82mobile.com (Next.js homepage)
   - Test /wp-admin access (should proxy to Gabia)
   - Test product listing (API call to WordPress)
   - Test cart functionality
6. Monitor error logs (Vercel dashboard, Sentry if configured)

**Health checks** (first 30 minutes):
- HTTP status codes (200 for pages, 401 for auth endpoints)
- API response times (< 2s)
- CORS headers present
- WordPress admin login working
- Cart operations working
- Payment modal opening

## Rollback Procedures

**If critical issues occur**:

1. **Immediate DNS rollback** (5-10 minute recovery):
   ```bash
   # Revert Cloudflare DNS to Gabia IP
   python3 scripts/cloudflare_dns_manager.py --rollback
   ```
   - 300s TTL means 5-10 min for most users to revert
   - Note: Some ISPs/browsers cache beyond TTL (15-30 min worst case)

2. **Identify root cause**:
   - Check Vercel logs for errors
   - Check WordPress API accessibility
   - Check CORS headers
   - Test /wp-admin proxy functionality

3. **Fix and retry**:
   - Fix issue on Vercel preview domain first
   - Re-verify full e-commerce flow
   - Schedule new cutover window

**Common failure modes**:
- CORS errors: Check .htaccess CORS headers include production domain
- /wp-admin 404: Check Vercel rewrites configuration
- API timeout: Check WordPress API accessibility from Vercel servers
- Cart not working: Check CoCart API calls from Next.js API routes

## Post-Cutover Monitoring

**First 24 hours**:
- Monitor Vercel dashboard for errors
- Check WordPress API response times
- Verify cart sessions persisting
- Test payment flow in production
- Monitor customer support channels

**First 72 hours**:
- Track Core Web Vitals (Vercel Analytics)
- Monitor order completion rate
- Check for CORS errors in browser console
- Verify /wp-admin performance acceptable

**Success criteria**:
- Zero downtime observed
- All customer-facing features working
- WordPress admin accessible
- No increase in support tickets
- Core Web Vitals maintained or improved

## Risk Assessment

**HIGH RISK**:
- No subdomain testing phase (immediate production cutover)
- DNS caching beyond TTL control (15-30 min worst case rollback)
- WordPress admin proxy latency (Vercel ‚Üí Gabia round-trip)

**MEDIUM RISK**:
- CORS headers not covering production domain
- Vercel rewrite configuration errors
- Cloudflare SSL/TLS mode misconfiguration

**LOW RISK**:
- Vercel global CDN more reliable than Gabia hosting
- 300s TTL enables fast rollback
- Preview domain testing catches most issues

**Mitigation**:
- Extensive Vercel preview domain testing (mandatory)
- Low-traffic cutover window (3-5 AM Korea)
- Automated health checks
- Clear rollback procedures documented
- Customer support team on standby

## Stakeholder Communication

**Before cutover** (24 hours):
- Email to customer: DNS cutover scheduled, expected downtime (if any)
- Prepare customer support team: Known issues, rollback plan

**During cutover**:
- Real-time monitoring dashboard
- Team chat for issue escalation

**After cutover** (1 hour):
- Email to customer: Cutover complete, verification passed
- Update status page (if available)

---

**Created**: 2026-01-27
**Strategy**: Immediate production cutover (user requirement)
**Approval required**: Yes (checkpoint)
```

3. Save document

**Verification**:
- [ ] DNS-CUTOVER-PLAN.md created
- [ ] All sections complete (pre-cutover, configuration, execution, rollback, monitoring)
- [ ] Vercel rewrites documented
- [ ] Rollback procedures clear

**Files created**: `.planning/phases/02-infrastructure-caching/DNS-CUTOVER-PLAN.md`

</task>

<task id="2" title="Create Cloudflare DNS automation script">

**Goal**: Python script for programmatic DNS changes via Cloudflare API with rollback capability.

**Steps**:
1. Create `/mnt/c/82Mobile/82mobile-next/scripts/cloudflare_dns_manager.py`
2. Implement Cloudflare API client:

```python
#!/usr/bin/env python3
"""
Cloudflare DNS Manager for 82mobile.com DNS Cutover

Manages DNS records for immediate cutover to Vercel and rollback to Gabia.
"""

import os
import sys
import argparse
from CloudFlare import CloudFlare

# DNS Targets
GABIA_IP = "xxx.xxx.xxx.xxx"  # TODO: Get current Gabia IP
VERCEL_IP = "76.76.21.21"
VERCEL_CNAME = "cname.vercel-dns.com"

# Cloudflare credentials (from environment)
CF_API_TOKEN = os.getenv('CLOUDFLARE_API_TOKEN')
ZONE_NAME = "82mobile.com"

def get_zone_id(cf, zone_name):
    """Get Cloudflare zone ID for domain"""
    zones = cf.zones.get(params={'name': zone_name})
    if not zones:
        raise Exception(f"Zone {zone_name} not found")
    return zones[0]['id']

def get_dns_record(cf, zone_id, record_name, record_type):
    """Get existing DNS record"""
    records = cf.zones.dns_records.get(
        zone_id,
        params={'name': record_name, 'type': record_type}
    )
    return records[0] if records else None

def update_dns_record(cf, zone_id, record_id, content, ttl=300):
    """Update DNS record content and TTL"""
    cf.zones.dns_records.put(
        zone_id,
        record_id,
        data={
            'content': content,
            'ttl': ttl
        }
    )

def cutover_to_vercel():
    """Execute DNS cutover to Vercel"""
    print("üöÄ Starting DNS cutover to Vercel...")

    cf = CloudFlare(token=CF_API_TOKEN)
    zone_id = get_zone_id(cf, ZONE_NAME)

    # Update A record: 82mobile.com ‚Üí Vercel IP
    print(f"Updating A record: {ZONE_NAME} ‚Üí {VERCEL_IP}")
    a_record = get_dns_record(cf, zone_id, ZONE_NAME, 'A')
    if a_record:
        update_dns_record(cf, zone_id, a_record['id'], VERCEL_IP, ttl=300)
        print(f"‚úì A record updated: {ZONE_NAME} ‚Üí {VERCEL_IP} (TTL: 300s)")
    else:
        print(f"‚úó A record not found for {ZONE_NAME}")

    # Update CNAME: www.82mobile.com ‚Üí Vercel CNAME
    print(f"Updating CNAME: www.{ZONE_NAME} ‚Üí {VERCEL_CNAME}")
    cname_record = get_dns_record(cf, zone_id, f"www.{ZONE_NAME}", 'CNAME')
    if cname_record:
        update_dns_record(cf, zone_id, cname_record['id'], VERCEL_CNAME, ttl=300)
        print(f"‚úì CNAME updated: www.{ZONE_NAME} ‚Üí {VERCEL_CNAME} (TTL: 300s)")
    else:
        print(f"‚úó CNAME record not found for www.{ZONE_NAME}")

    print("‚úÖ DNS cutover complete!")
    print(f"   Propagation time: ~5-10 minutes (TTL: 300s)")
    print(f"   Verify: dig {ZONE_NAME} (should return {VERCEL_IP})")

def rollback_to_gabia():
    """Rollback DNS to Gabia hosting"""
    print("üîÑ Rolling back DNS to Gabia...")

    cf = CloudFlare(token=CF_API_TOKEN)
    zone_id = get_zone_id(cf, ZONE_NAME)

    # Revert A record: 82mobile.com ‚Üí Gabia IP
    print(f"Reverting A record: {ZONE_NAME} ‚Üí {GABIA_IP}")
    a_record = get_dns_record(cf, zone_id, ZONE_NAME, 'A')
    if a_record:
        update_dns_record(cf, zone_id, a_record['id'], GABIA_IP, ttl=300)
        print(f"‚úì A record reverted: {ZONE_NAME} ‚Üí {GABIA_IP} (TTL: 300s)")
    else:
        print(f"‚úó A record not found for {ZONE_NAME}")

    # Revert CNAME: www.82mobile.com ‚Üí 82mobile.com
    print(f"Reverting CNAME: www.{ZONE_NAME} ‚Üí {ZONE_NAME}")
    cname_record = get_dns_record(cf, zone_id, f"www.{ZONE_NAME}", 'CNAME')
    if cname_record:
        update_dns_record(cf, zone_id, cname_record['id'], ZONE_NAME, ttl=300)
        print(f"‚úì CNAME reverted: www.{ZONE_NAME} ‚Üí {ZONE_NAME} (TTL: 300s)")
    else:
        print(f"‚úó CNAME record not found for www.{ZONE_NAME}")

    print("‚úÖ DNS rollback complete!")
    print(f"   Propagation time: ~5-10 minutes (TTL: 300s)")
    print(f"   Verify: dig {ZONE_NAME} (should return {GABIA_IP})")

def lower_ttl():
    """Lower DNS TTL to 300s (72 hours before cutover)"""
    print("‚è∞ Lowering DNS TTL to 300s...")

    cf = CloudFlare(token=CF_API_TOKEN)
    zone_id = get_zone_id(cf, ZONE_NAME)

    # Lower A record TTL
    a_record = get_dns_record(cf, zone_id, ZONE_NAME, 'A')
    if a_record:
        current_content = a_record['content']
        update_dns_record(cf, zone_id, a_record['id'], current_content, ttl=300)
        print(f"‚úì A record TTL lowered: {ZONE_NAME} (TTL: 300s)")

    # Lower CNAME TTL
    cname_record = get_dns_record(cf, zone_id, f"www.{ZONE_NAME}", 'CNAME')
    if cname_record:
        current_content = cname_record['content']
        update_dns_record(cf, zone_id, cname_record['id'], current_content, ttl=300)
        print(f"‚úì CNAME TTL lowered: www.{ZONE_NAME} (TTL: 300s)")

    print("‚úÖ TTL lowered to 300s!")
    print("   Run cutover 72 hours from now for TTL propagation")

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Cloudflare DNS Manager')
    parser.add_argument('--cutover', action='store_true', help='Execute DNS cutover to Vercel')
    parser.add_argument('--rollback', action='store_true', help='Rollback DNS to Gabia')
    parser.add_argument('--lower-ttl', action='store_true', help='Lower TTL to 300s')

    args = parser.parse_args()

    if not CF_API_TOKEN:
        print("Error: CLOUDFLARE_API_TOKEN environment variable not set")
        sys.exit(1)

    if args.cutover:
        cutover_to_vercel()
    elif args.rollback:
        rollback_to_gabia()
    elif args.lower_ttl:
        lower_ttl()
    else:
        parser.print_help()
```

3. Install Cloudflare SDK: `pip install cloudflare`
4. Get current Gabia IP: `dig 82mobile.com` and update `GABIA_IP` in script
5. Test script (dry-run mode): Add `--dry-run` flag that prints changes without executing

**Verification**:
- [ ] Script created
- [ ] Cloudflare SDK installed
- [ ] Current Gabia IP documented in script
- [ ] Dry-run mode working

**Files created**: `scripts/cloudflare_dns_manager.py`

</task>

<task id="3" title="Create Vercel configuration with rewrites">

**Goal**: Create `vercel.json` with WordPress admin proxy rewrites.

**Steps**:
1. Create `/mnt/c/82Mobile/82mobile-next/vercel.json`:

```json
{
  "version": 2,
  "rewrites": [
    {
      "source": "/wp-admin",
      "destination": "http://82mobile.com/wp-admin"
    },
    {
      "source": "/wp-admin/:path*",
      "destination": "http://82mobile.com/wp-admin/:path*"
    },
    {
      "source": "/wp-login.php",
      "destination": "http://82mobile.com/wp-login.php"
    },
    {
      "source": "/wp-includes/:path*",
      "destination": "http://82mobile.com/wp-includes/:path*"
    },
    {
      "source": "/wp-content/:path*",
      "destination": "http://82mobile.com/wp-content/:path*"
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Frame-Options",
          "value": "SAMEORIGIN"
        },
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        }
      ]
    }
  ]
}
```

2. Commit to git:
   ```bash
   git add vercel.json
   git commit -m "feat(02-03): add Vercel rewrites for WordPress admin proxy"
   ```

3. Document rewrite behavior in DNS-CUTOVER-PLAN.md

**Verification**:
- [ ] vercel.json created
- [ ] Rewrites configured for all WordPress paths
- [ ] Security headers added
- [ ] Committed to git

**Files created**: `vercel.json`

</task>

## Checkpoint: DNS Strategy Approval

**At this point**: DNS cutover plan document complete, automation script ready, Vercel configuration prepared.

**Review required**:
1. Open `.planning/phases/02-infrastructure-caching/DNS-CUTOVER-PLAN.md`
2. Review immediate cutover strategy (no subdomain)
3. Review pre-cutover requirements (Phases 3-6 must complete first)
4. Review rollback procedures
5. Confirm understanding of risks

**User approval needed**: Proceed with this DNS strategy?

## Must-Haves (Goal-Backward Verification)

When this plan completes, these must be TRUE:

1. **DNS strategy documented**: Comprehensive DNS-CUTOVER-PLAN.md exists with immediate cutover approach, pre-cutover requirements, execution steps, rollback procedures

2. **Automation ready**: `cloudflare_dns_manager.py` script functional for DNS cutover and rollback via Cloudflare API

3. **Vercel configured**: `vercel.json` created with WordPress admin proxy rewrites

4. **Strategy approved**: User reviewed DNS-CUTOVER-PLAN.md and confirmed immediate cutover approach (checkpoint)

5. **DEPLOY-04 requirement fulfilled**: DNS configuration for zero downtime cutover documented and tooling prepared

**Success means**: Production-ready DNS cutover plan with automation, ready to execute after Phases 3-6 complete.

## Dependencies

**Requires**:
- Plans 02-01, 02-02 complete (cache verification, Redis status)
- Cloudflare account access
- Cloudflare API token

**Blocks**:
- Phase 7 DNS cutover execution (waits for Phases 3-6 completion)

**Enables**:
- Phase 3 can begin (DNS strategy documented)
- Clear roadmap for production deployment

## Notes

- **This plan does NOT execute DNS cutover** - only prepares strategy and tooling
- DNS cutover happens in Phase 7 after all features complete
- Checkpoint required: User must approve immediate cutover strategy
- No subdomain testing per user requirement ("Î∞îÎ°ú Ï†ÑÌôò")

## Estimated Duration

1 hour (excluding user approval wait time)
