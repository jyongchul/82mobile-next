---
phase: 03-nextjs-api-routes-authentication
plan: 02
type: execute
wave: 1
depends_on: ["03-01"]
files_modified:
  - app/api/auth/token/route.ts
  - app/api/cart/route.ts
  - app/api/cart/add-item/route.ts
  - app/api/cart/remove-item/route.ts
  - app/api/cart/update-item/route.ts
  - app/api/cart/clear/route.ts
  - app/api/products/[slug]/route.ts
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "/api/auth/token generates JWT tokens by authenticating with WordPress JWT plugin"
    - "/api/cart routes proxy CoCart API with form-encoded requests (Gabia WAF requirement)"
    - "/api/products/[slug] returns single product data with variations"
    - "JWT middleware validates tokens for protected routes using jose library"
    - "All API routes return consistent JSON structure (success, data/error, message)"
  artifacts:
    - path: "app/api/auth/token/route.ts"
      provides: "JWT token generation endpoint"
      exports: ["POST"]
    - path: "app/api/cart/route.ts"
      provides: "Cart retrieval endpoint"
      exports: ["GET"]
    - path: "app/api/cart/add-item/route.ts"
      provides: "Add item to cart endpoint"
      exports: ["POST"]
    - path: "middleware.ts"
      provides: "JWT validation middleware for protected routes"
      exports: ["middleware"]
  key_links:
    - from: "app/api/auth/token/route.ts"
      to: "lib/wordpress-auth.ts"
      via: "getJwtToken() utility"
      pattern: "import.*getJwtToken.*from.*wordpress-auth"
    - from: "app/api/cart/add-item/route.ts"
      to: "lib/cart-session.ts"
      via: "addCartItem() utility"
      pattern: "import.*addCartItem.*from.*cart-session"
    - from: "middleware.ts"
      to: "lib/wordpress-auth.ts"
      via: "verifyJwtToken() for auth validation"
      pattern: "import.*verifyJwtToken.*from.*wordpress-auth"
---

<objective>
Build Next.js 14 App Router Route Handlers for authentication and cart management, extending existing products/orders routes to complete the Backend-for-Frontend API proxy layer.

Purpose: Phase 3 requires `/api/auth/token` for JWT generation and `/api/cart/*` routes for CoCart integration. These routes leverage the utilities created in Plan 03-01 (wordpress-auth.ts, cart-session.ts) and follow existing patterns in `/app/api/products/route.ts`.

Output: 7 new Route Handler files + JWT middleware, all using TypeScript and proper error handling.
</objective>

<execution_context>
@/home/charles_lee/.claude/get-shit-done/workflows/execute-plan.md
@/home/charles_lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-nextjs-api-routes-authentication/03-RESEARCH.md
@.planning/phases/03-nextjs-api-routes-authentication/03-01-SUMMARY.md
@app/api/products/route.ts
@lib/wordpress-auth.ts
@lib/cart-session.ts
@lib/api-error.ts

Key constraints from prior plans:
- Next.js 14.2.0 App Router (use Route Handlers, NOT Pages Router API Routes)
- JWT authentication uses jose library (Edge Runtime compatible)
- CoCart requires `application/x-www-form-urlencoded` (Gabia WAF blocks JSON)
- All API routes use `export const dynamic = 'force-dynamic'` to disable caching
- Consistent error responses via lib/api-error.ts (handleApiError function)
- TypeScript types from lib/types/api.ts
- Environment variables accessed via lib/env.ts
- Existing products route at app/api/products/route.ts follows the pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JWT authentication endpoint</name>
  <files>app/api/auth/token/route.ts</files>
  <action>
    1. Create directory: `mkdir -p app/api/auth/token`

    2. Create `app/api/auth/token/route.ts`:
       - Import: NextResponse, getJwtToken from lib/wordpress-auth, handleApiError from lib/api-error
       - Export: `export const dynamic = 'force-dynamic'`
       - Implement POST handler:
         - Parse request body: `const { username, password } = await request.json()`
         - Validate inputs (username and password required)
         - Call `getJwtToken(username, password)` from lib/wordpress-auth
         - If null: return error response with 401 status
         - If success: return JWT token and user info in standard API format
         - Set httpOnly cookie: `res.cookies.set('auth-token', token, { httpOnly: true, secure: production, sameSite: 'strict', maxAge: 7 days })`
         - Wrap in try/catch using handleApiError
       - Follow pattern from 03-RESEARCH.md Pattern 2: JWT Token Generation Endpoint

    3. Add TypeScript types:
       - Request body: `{ username: string, password: string }`
       - Response: `{ success: true, token: string, user: { id, email, displayName } }`
  </action>
  <verify>
    File exists: app/api/auth/token/route.ts
    File imports getJwtToken from lib/wordpress-auth
    POST handler implemented with httpOnly cookie
    Error handling uses handleApiError
  </verify>
  <done>
    JWT authentication endpoint created. POST /api/auth/token generates tokens via WordPress JWT plugin and stores in httpOnly cookie.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cart management endpoints</name>
  <files>app/api/cart/route.ts, app/api/cart/add-item/route.ts, app/api/cart/remove-item/route.ts, app/api/cart/update-item/route.ts, app/api/cart/clear/route.ts</files>
  <action>
    1. Create directories:
       ```bash
       mkdir -p app/api/cart/add-item
       mkdir -p app/api/cart/remove-item
       mkdir -p app/api/cart/update-item
       mkdir -p app/api/cart/clear
       ```

    2. Create `app/api/cart/route.ts` (GET cart):
       - Import: NextResponse, getCart from lib/cart-session, handleApiError
       - Export: `export const dynamic = 'force-dynamic'`
       - Implement GET handler:
         - Extract cartKey from cookies: `request.cookies.get('cart-key')?.value`
         - Call `getCart(cartKey)` from lib/cart-session
         - Return cart data or empty cart if null
         - Use try/catch with handleApiError

    3. Create `app/api/cart/add-item/route.ts` (POST):
       - Import: NextResponse, addCartItem from lib/cart-session, handleApiError
       - Implement POST handler:
         - Parse request body: `{ productId, quantity, variationId? }`
         - Validate inputs (productId and quantity required)
         - Extract cartKey from cookies
         - Call `addCartItem(productId, quantity, cartKey, variationId)`
         - If result has new cart_key, set cookie: `res.cookies.set('cart-key', cart.cart_key, { httpOnly: false, maxAge: 30 days })`
         - Return updated cart
         - CRITICAL: addCartItem uses form-encoded format internally (already handled in lib/cart-session.ts)

    4. Create `app/api/cart/remove-item/route.ts` (DELETE):
       - Implement DELETE handler with itemKey from request body
       - Call `removeCartItem(itemKey, cartKey)` from lib/cart-session
       - Return updated cart

    5. Create `app/api/cart/update-item/route.ts` (PUT):
       - Implement PUT handler with itemKey and quantity from request body
       - Call `updateCartItem(itemKey, quantity, cartKey)` from lib/cart-session
       - Return updated cart

    6. Create `app/api/cart/clear/route.ts` (POST):
       - Implement POST handler
       - Call `clearCart(cartKey)` from lib/cart-session
       - Return empty cart confirmation
  </action>
  <verify>
    5 cart route files exist in app/api/cart/
    All routes import from lib/cart-session
    All routes use handleApiError for error handling
    cart-key cookie set in add-item route (httpOnly: false for client access)
    All routes use `export const dynamic = 'force-dynamic'`
  </verify>
  <done>
    Cart management endpoints created. 5 routes handle cart operations via CoCart API with form-encoded requests.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create product detail endpoint and JWT middleware</name>
  <files>app/api/products/[slug]/route.ts, middleware.ts</files>
  <action>
    1. Create `app/api/products/[slug]/route.ts`:
       - Directory: `mkdir -p app/api/products/[slug]`
       - Import: NextResponse, woo client from lib/woocommerce, handleApiError
       - Export: `export const dynamic = 'force-dynamic'`
       - Implement GET handler:
         - Extract slug from route params: `params.slug`
         - Fetch single product: `await woo.get('products', { slug })`
         - Transform product data (same format as products list route)
         - Return product or 404 if not found
         - Use try/catch with handleApiError

    2. Create `middleware.ts` (root level):
       - Import: NextResponse, NextRequest, verifyJwtToken from lib/wordpress-auth
       - Implement middleware function:
         - Check if path requires auth: `/api/orders/*`, `/api/cart/*` (cart needs session, not strict auth)
         - For protected routes: extract auth-token cookie
         - If no token and route requires auth: return 401
         - Call `verifyJwtToken(token)` from lib/wordpress-auth
         - If invalid: return 401 with error message
         - If valid: add user info to request headers (`x-user-id`, `x-user-email`)
         - Return NextResponse.next() with modified headers
       - Export: `export const config = { matcher: ['/api/orders/:path*', '/api/profile/:path*'] }`
       - Follow pattern from 03-RESEARCH.md Pattern 3: JWT Middleware

    3. Note: Cart routes should NOT require strict JWT auth (guest carts allowed)
       - Middleware matches `/api/orders/*` only (orders require auth)
       - Cart routes accessible without JWT (session via cart-key cookie)
  </action>
  <verify>
    File exists: app/api/products/[slug]/route.ts
    File exists: middleware.ts (root level)
    middleware.ts imports verifyJwtToken from lib/wordpress-auth
    middleware.ts uses jose library for JWT verification (via lib utility)
    Middleware config matcher includes /api/orders/* but NOT /api/cart/*
  </verify>
  <done>
    Product detail endpoint and JWT middleware created. Middleware protects orders routes; cart routes remain accessible for guest users.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. All 7 new route files exist in `app/api/`
4. `grep -r "getJwtToken" app/api/auth/token/route.ts` returns matches
5. `grep -r "addCartItem\|removeCartItem\|updateCartItem" app/api/cart/` returns matches
6. `grep -r "verifyJwtToken" middleware.ts` returns matches
7. `grep -r "httpOnly.*false" app/api/cart/add-item/route.ts` returns matches (cart-key cookie accessible to client)
8. Test JWT endpoint: `curl -X POST http://localhost:3000/api/auth/token -H "Content-Type: application/json" -d '{"username":"test","password":"test"}'`
9. Test cart endpoint: `curl http://localhost:3000/api/cart`
</verification>

<success_criteria>
- 7 new Route Handler files created with proper TypeScript types
- JWT authentication endpoint generates tokens and sets httpOnly cookies
- Cart endpoints proxy CoCart API (form-encoded format handled by lib/cart-session.ts)
- Product detail endpoint returns single product with variations
- JWT middleware validates tokens for protected routes (orders)
- All routes use consistent error handling via handleApiError
- Build passes without errors
- Cart routes accessible without JWT (guest carts supported)
</success_criteria>

<output>
After completion, create `.planning/phases/03-nextjs-api-routes-authentication/03-02-SUMMARY.md`
</output>
