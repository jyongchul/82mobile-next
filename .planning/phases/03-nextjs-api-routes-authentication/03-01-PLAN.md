---
phase: 03-nextjs-api-routes-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/env.ts
  - lib/api-error.ts
  - lib/types/api.ts
  - lib/types/woocommerce.ts
  - lib/wordpress-auth.ts
  - lib/cart-session.ts
autonomous: true

must_haves:
  truths:
    - "Environment variables validated at startup with clear error messages for missing credentials"
    - "API error responses follow consistent structure across all routes"
    - "TypeScript types exist for all API request/response contracts"
  artifacts:
    - path: "lib/env.ts"
      provides: "Centralized environment variable validation using zod"
      contains: "envSchema"
    - path: "lib/api-error.ts"
      provides: "Reusable error handling utility for Route Handlers"
      exports: ["handleApiError", "ApiError"]
    - path: "lib/types/api.ts"
      provides: "API response type definitions"
      contains: "ApiResponse"
    - path: "lib/wordpress-auth.ts"
      provides: "JWT authentication utilities for WordPress"
      exports: ["getJwtToken", "verifyJwtToken"]
    - path: "lib/cart-session.ts"
      provides: "CoCart session management utilities"
      exports: ["getCart", "addCartItem", "removeCartItem"]
  key_links:
    - from: "lib/env.ts"
      to: "process.env"
      via: "zod schema validation"
      pattern: "envSchema\\.parse"
    - from: "lib/wordpress-auth.ts"
      to: "WordPress JWT plugin"
      via: "fetch to /wp-json/jwt-auth/v1/token"
      pattern: "jwt-auth/v1/token"
    - from: "lib/cart-session.ts"
      to: "CoCart API"
      via: "fetch with form-encoded content type"
      pattern: "cocart/v2"
---

<objective>
Create shared infrastructure libraries for Phase 3 API routes: environment validation, error handling, TypeScript types, JWT auth utilities, and CoCart session management.

Purpose: All API routes in subsequent plans depend on these shared utilities. Centralizing env validation prevents runtime failures; shared types ensure consistency; auth and cart utilities encapsulate WordPress-specific quirks (JWT plugin, CoCart form-encoded requirement).

Output: 6 library files in `lib/` providing reusable utilities for all API Route Handlers.
</objective>

<execution_context>
@/home/charles_lee/.claude/get-shit-done/workflows/execute-plan.md
@/home/charles_lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/woocommerce.ts
@.planning/phases/03-nextjs-api-routes-authentication/03-RESEARCH.md

Key constraints from prior phases:
- CoCart requires `application/x-www-form-urlencoded` content type (Gabia WAF blocks JSON)
- WordPress JWT plugin at `/wp-json/jwt-auth/v1/token`
- WooCommerce client already configured in `lib/woocommerce.ts`
- Environment variables: WORDPRESS_URL, WC_CONSUMER_KEY, WC_CONSUMER_SECRET (existing), JWT_SECRET, COCART_API_URL (new)
- Use `jose` library for JWT verification (Edge Runtime compatible), NOT jsonwebtoken
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment validation and error handling utilities</name>
  <files>lib/env.ts, lib/api-error.ts, lib/types/api.ts</files>
  <action>
    1. Install `jose` dependency: `npm install jose`

    2. Create `lib/env.ts`:
       - Define zod schema for all required env vars: WORDPRESS_URL (string url), WC_CONSUMER_KEY (string starting with 'ck_'), WC_CONSUMER_SECRET (string starting with 'cs_'), JWT_SECRET (string min 16 chars), COCART_API_URL (string url, optional with default to WORDPRESS_URL + '/wp-json/cocart/v2'), NODE_ENV (enum)
       - Export `validateEnv()` function and lazy-initialized `env` constant
       - Use lazy validation (validate on first access, not module load) to avoid breaking builds when env vars aren't yet set

    3. Create `lib/api-error.ts`:
       - Export `ApiError` interface: { success: false, error: string, message: string, code?: string }
       - Export `handleApiError(error: any, context: string)` function returning NextResponse
       - Handle WordPress/WooCommerce errors (error.response?.data), network errors (ECONNREFUSED/ETIMEDOUT), and generic errors
       - Always return consistent JSON structure: { success: false, error, message, code }

    4. Create `lib/types/api.ts`:
       - Import WooProduct, WooOrder from existing `lib/woocommerce.ts` (use relative import `../woocommerce`)
       - Export `ApiResponse<T>`, `ProductsResponse`, `ProductResponse`, `OrderResponse`, `CartResponse`, `CartItem`, `AuthTokenResponse` types
       - Follow patterns from 03-RESEARCH.md code examples section
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors in new files.
    Run `npm run build` - build succeeds (env validation is lazy, won't fail without vars).
  </verify>
  <done>
    Three utility files exist with proper TypeScript types. Build passes. Environment validation schema covers all required variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JWT auth and CoCart session utilities</name>
  <files>lib/wordpress-auth.ts, lib/cart-session.ts</files>
  <action>
    1. Create `lib/wordpress-auth.ts`:
       - Export `getJwtToken(username: string, password: string): Promise<{token: string, user: {email: string, displayName: string}} | null>`
         - POST to `${WORDPRESS_URL}/wp-json/jwt-auth/v1/token` with JSON body
         - Return parsed token and user info, or null on failure
       - Export `verifyJwtToken(token: string): Promise<{valid: boolean, payload?: any}>`
         - Use `jose` library's `jwtVerify` with JWT_SECRET from env
         - Return { valid: true, payload } or { valid: false }
       - Export `createAuthHeaders(token: string): HeadersInit`
         - Return { 'Authorization': `Bearer ${token}` }
       - Use env vars via lazy import from lib/env.ts (handle case where env validation hasn't run)
       - Fallback: if env.ts validation fails, read directly from process.env with console.warn

    2. Create `lib/cart-session.ts`:
       - Base URL: `${WORDPRESS_URL}/wp-json/cocart/v2`
       - Export `getCart(cartKey?: string): Promise<any>`
         - GET to `/cart` with optional `Cart-Key` header
       - Export `addCartItem(productId: number, quantity: number, cartKey?: string): Promise<any>`
         - POST to `/cart/add-item` with `application/x-www-form-urlencoded` content type
         - Body: `new URLSearchParams({ id: productId.toString(), quantity: quantity.toString() })`
         - CRITICAL: Must use form-encoded, NOT JSON (Gabia WAF blocks JSON to CoCart)
       - Export `removeCartItem(itemKey: string, cartKey?: string): Promise<any>`
         - DELETE to `/cart/item/${itemKey}`
       - Export `updateCartItem(itemKey: string, quantity: number, cartKey?: string): Promise<any>`
         - POST to `/cart/item/${itemKey}` with form-encoded body
       - Export `clearCart(cartKey?: string): Promise<any>`
         - POST to `/cart/clear`
       - All functions: include error handling with console.error, return null on failure
       - All functions: accept optional cartKey for session persistence
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors.
    Verify `lib/cart-session.ts` uses `application/x-www-form-urlencoded` (not JSON) for POST requests.
    Verify `lib/wordpress-auth.ts` imports from `jose` library.
  </verify>
  <done>
    JWT auth utilities can generate and verify tokens. CoCart session utilities handle all cart operations with form-encoded content type. Both files compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. All 6 library files exist in `lib/`
4. `grep -r "application/x-www-form-urlencoded" lib/cart-session.ts` returns matches (confirms CoCart form-encoded requirement)
5. `grep -r "jose" lib/wordpress-auth.ts` returns matches (confirms Edge-compatible JWT library)
6. `grep -r "NEXT_PUBLIC" lib/env.ts` returns NO matches (confirms no credential exposure)
</verification>

<success_criteria>
- 6 library files created with proper TypeScript types
- Build passes without errors
- Environment validation covers all required variables
- JWT utilities use jose (Edge Runtime compatible)
- CoCart utilities use form-encoded format (Gabia hosting requirement)
- No credentials exposed via NEXT_PUBLIC_ prefix
</success_criteria>

<output>
After completion, create `.planning/phases/03-nextjs-api-routes-authentication/03-01-SUMMARY.md`
</output>
