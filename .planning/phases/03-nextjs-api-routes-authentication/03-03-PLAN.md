---
phase: 03-nextjs-api-routes-authentication
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - .env.local
  - .env.example
  - README.md
autonomous: true

must_haves:
  truths:
    - "All required environment variables documented in .env.example with descriptions"
    - "Local development uses .env.local with actual values"
    - "Vercel environment variables configured for all environments (development, preview, production)"
    - "No credentials exposed in client-side code (all accessed server-side only)"
    - "README.md documents environment setup steps for new developers"
  artifacts:
    - path: ".env.example"
      provides: "Environment variable template with descriptions"
      contains: "WORDPRESS_URL, WC_CONSUMER_KEY, WC_CONSUMER_SECRET, JWT_SECRET, COCART_API_URL"
    - path: ".env.local"
      provides: "Local development environment variables"
      excludes: "Committed to git (in .gitignore)"
    - path: "README.md"
      provides: "Environment setup documentation"
      contains: "Environment variables section with setup instructions"
  key_links:
    - from: ".env.example"
      to: "Vercel Dashboard"
      via: "Environment variables configuration guide"
      pattern: "How to set in Vercel"
    - from: "lib/env.ts"
      to: "process.env"
      via: "Environment variable validation"
      pattern: "envSchema.parse"
---

<objective>
Configure environment variables for local development and Vercel deployment, ensuring secure credential management across all environments.

Purpose: Phase 3 Success Criteria #4-5 require WooCommerce credentials never exposed to browser and environment variables working in all Vercel environments. This plan documents all required variables, provides setup instructions, and configures Vercel dashboard.

Output: Updated .env.example, .env.local setup, README documentation, Vercel environment configuration verified.
</objective>

<execution_context>
@/home/charles_lee/.claude/get-shit-done/workflows/execute-plan.md
@/home/charles_lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-nextjs-api-routes-authentication/03-RESEARCH.md
@lib/env.ts
@.env.example

Key constraints:
- Environment variables validated by lib/env.ts (created in 03-01)
- JWT_SECRET required for JWT verification (jose library)
- COCART_API_URL required for cart session management
- WC_CONSUMER_KEY and WC_CONSUMER_SECRET for WooCommerce OAuth
- WORDPRESS_URL for backend API endpoint
- NEXT_PUBLIC_* prefix FORBIDDEN for credentials (server-side only)
- Vercel requires separate configuration for development/preview/production environments
- .env.local should exist but not be committed (in .gitignore)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update environment variable templates</name>
  <files>.env.example, .env.local</files>
  <action>
    1. Update `.env.example` with all required variables and descriptions:
       ```bash
       # WordPress Backend API Configuration
       WORDPRESS_URL=https://82mobile.com

       # WooCommerce REST API Credentials (OAuth 1.0a)
       # Generate at: WordPress Admin > WooCommerce > Settings > Advanced > REST API
       WC_CONSUMER_KEY=ck_your_consumer_key_here
       WC_CONSUMER_SECRET=cs_your_consumer_secret_here

       # JWT Authentication Secret
       # Must match WordPress JWT_AUTH_SECRET_KEY in wp-config.php
       # Generate with: openssl rand -base64 64
       JWT_SECRET=your_jwt_secret_minimum_16_characters

       # CoCart API Endpoint (optional, defaults to WORDPRESS_URL/wp-json/cocart/v2)
       COCART_API_URL=https://82mobile.com/wp-json/cocart/v2

       # Node Environment
       NODE_ENV=development

       # CRITICAL: Do NOT use NEXT_PUBLIC_ prefix for any of these
       # All credentials must be accessed server-side only (API Routes)
       ```

    2. Create `.env.local` (if not exists):
       - Copy from .env.example
       - Fill in actual development values
       - Use real WooCommerce API credentials from WordPress dashboard
       - Use actual JWT_SECRET from WordPress wp-config.php
       - Verify `.env.local` is in .gitignore (should already be)

    3. Update `.gitignore` (if needed):
       - Ensure `.env.local` is listed
       - Ensure `.env*.local` pattern exists
       - Do NOT commit credentials
  </action>
  <verify>
    File exists: .env.example with all 5 required variables documented
    File exists: .env.local (not committed to git)
    .gitignore contains .env.local or .env*.local pattern
    .env.example includes security warnings about NEXT_PUBLIC_ prefix
    All variables have descriptive comments explaining purpose and how to generate
  </verify>
  <done>
    Environment variable templates updated. .env.example documents all variables; .env.local configured for local development.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document environment setup in README</name>
  <files>README.md</files>
  <action>
    1. Read existing README.md to understand current structure

    2. Add or update "Environment Variables" section:
       ```markdown
       ## Environment Variables

       This project requires the following environment variables:

       ### Required Variables

       | Variable | Description | Example | Where to Get |
       |----------|-------------|---------|--------------|
       | `WORDPRESS_URL` | WordPress backend API URL | `https://82mobile.com` | Your WordPress installation URL |
       | `WC_CONSUMER_KEY` | WooCommerce API consumer key | `ck_abc123...` | WordPress Admin > WooCommerce > Settings > Advanced > REST API |
       | `WC_CONSUMER_SECRET` | WooCommerce API consumer secret | `cs_xyz789...` | Same as consumer key |
       | `JWT_SECRET` | JWT authentication secret | (64+ char random string) | Generate: `openssl rand -base64 64` |
       | `COCART_API_URL` | CoCart API endpoint (optional) | `https://82mobile.com/wp-json/cocart/v2` | Defaults to WORDPRESS_URL + path |

       ### Local Development Setup

       1. Copy `.env.example` to `.env.local`:
          ```bash
          cp .env.example .env.local
          ```

       2. Fill in actual values in `.env.local`

       3. **CRITICAL**: Never commit `.env.local` or expose credentials in client-side code

       ### Vercel Deployment Setup

       1. Go to Vercel Dashboard > Your Project > Settings > Environment Variables

       2. Add all variables from `.env.example` with production values

       3. Set environment scope:
          - `WORDPRESS_URL`: All environments (development, preview, production)
          - `WC_CONSUMER_KEY`: Production only (use test keys for preview)
          - `WC_CONSUMER_SECRET`: Production only
          - `JWT_SECRET`: Production only (use separate secret for preview)

       4. Redeploy after adding variables

       ### Security Notes

       - **DO NOT** use `NEXT_PUBLIC_` prefix for any credentials
       - All API credentials accessed server-side only (Next.js API Routes)
       - JWT tokens stored in httpOnly cookies (not accessible via JavaScript)
       - Environment variables validated at startup via `lib/env.ts`
       ```

    3. Add to "Getting Started" section (if exists):
       - Step for copying .env.example to .env.local
       - Step for filling in environment variables
       - Reference to Environment Variables section for details
  </action>
  <verify>
    README.md contains "Environment Variables" section
    Documentation includes table with all 5 variables
    Vercel deployment setup instructions included
    Security notes warn about NEXT_PUBLIC_ prefix
    Getting Started section references environment setup
  </verify>
  <done>
    README.md updated with comprehensive environment setup documentation including local development and Vercel deployment instructions.
  </done>
</task>

<task type="manual">
  <name>Task 3: Configure Vercel environment variables</name>
  <files>None (Vercel Dashboard configuration)</files>
  <action>
    **Manual Steps** (requires Vercel dashboard access):

    1. Navigate to: Vercel Dashboard > 82mobile-next project > Settings > Environment Variables

    2. Add Production Variables:
       - Name: `WORDPRESS_URL`, Value: `https://82mobile.com`, Environment: Production
       - Name: `WC_CONSUMER_KEY`, Value: (from WordPress), Environment: Production
       - Name: `WC_CONSUMER_SECRET`, Value: (from WordPress), Environment: Production
       - Name: `JWT_SECRET`, Value: (from WordPress wp-config.php), Environment: Production
       - Name: `COCART_API_URL`, Value: `https://82mobile.com/wp-json/cocart/v2`, Environment: Production

    3. Add Preview Variables (use test credentials):
       - Same variables as production
       - Use WooCommerce test API keys for preview environment
       - Use separate JWT_SECRET for preview (different from production)

    4. Add Development Variables:
       - Same variables as production
       - Use localhost WordPress if available, or shared dev WordPress

    5. Verify configuration:
       - Check all 5 variables present for each environment
       - Verify no NEXT_PUBLIC_ prefixed credentials exist
       - Confirm variables are marked as "Sensitive" (encrypted)

    6. Trigger redeployment:
       - Go to Deployments tab
       - Click "Redeploy" on latest deployment
       - Verify build succeeds with environment variables loaded

    **Verification Steps:**
    - After deployment, test: `curl https://your-preview-url.vercel.app/api/products`
    - Should return products from WordPress API (proves WC credentials work)
    - Test: `curl -X POST https://your-preview-url.vercel.app/api/auth/token -d '{"username":"test","password":"test"}'`
    - Should attempt authentication (proves JWT_SECRET loaded)
  </action>
  <verify>
    Vercel dashboard shows 5 environment variables configured
    All variables marked as "Sensitive"
    Variables configured for all 3 environments (development, preview, production)
    Test API call to /api/products succeeds on Vercel preview URL
    No build errors related to missing environment variables
  </verify>
  <done>
    Vercel environment variables configured for all environments. API routes can access WordPress/WooCommerce credentials securely.
  </done>
</task>

</tasks>

<verification>
1. `.env.example` contains all 5 required variables with descriptions
2. `.env.local` exists and is in .gitignore
3. `grep -r "NEXT_PUBLIC_.*SECRET\|NEXT_PUBLIC_.*KEY" .` returns NO matches (no credential exposure)
4. README.md contains comprehensive environment setup documentation
5. Vercel dashboard shows all 5 variables configured (manual verification)
6. Test production build locally: `npm run build` succeeds with .env.local
7. Test Vercel deployment: Preview URL responds to `/api/products`
</verification>

<success_criteria>
- All environment variables documented in .env.example with descriptions
- Local .env.local configured and excluded from git
- README.md provides clear setup instructions for developers
- Vercel environment variables configured for all environments
- No credentials exposed with NEXT_PUBLIC_ prefix
- API routes successfully access environment variables in all environments
- Test deployments verify environment variable loading
</success_criteria>

<output>
After completion, create `.planning/phases/03-nextjs-api-routes-authentication/03-03-SUMMARY.md`
</output>
