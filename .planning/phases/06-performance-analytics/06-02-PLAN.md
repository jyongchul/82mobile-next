---
wave: 2
depends_on: [06-01]
files_modified:
  - app/layout.tsx
  - lib/performance.ts
  - components/performance/WebVitals.tsx
autonomous: true
---

# Plan 06-02: Core Web Vitals Monitoring

## Objective

Implement real-time Core Web Vitals (CWV) monitoring using Next.js built-in web vitals reporting and send data to GA4 for performance tracking.

## Context

**Current State:**
- No performance monitoring in place
- Estimated LCP: 2.0-2.5s (from build analysis)
- Bundle sizes: 118-125KB (under 220KB target)
- GA4 integrated (Plan 06-01 complete)

**What We're Measuring:**
- **LCP (Largest Contentful Paint):** <2.5s (good), 2.5-4s (needs improvement), >4s (poor)
- **FID (First Input Delay):** <100ms (good), 100-300ms (needs improvement), >300ms (poor)
- **CLS (Cumulative Layout Shift):** <0.1 (good), 0.1-0.25 (needs improvement), >0.25 (poor)
- **FCP (First Contentful Paint):** <1.8s (good), 1.8-3s (needs improvement), >3s (poor)
- **TTFB (Time to First Byte):** <800ms (good), 800-1800ms (needs improvement), >1800ms (poor)
- **INP (Interaction to Next Paint):** <200ms (good), 200-500ms (needs improvement), >500ms (poor)

## Tasks

<task id="1" name="Create Web Vitals utility">

**Action:** Create performance monitoring utility using Next.js web-vitals library

**Steps:**
1. Create `lib/performance.ts`:
   ```typescript
   import { Metric } from 'web-vitals'
   import { event } from './analytics'

   // Send Web Vitals to GA4
   export function sendToGA4(metric: Metric) {
     const { name, value, id, rating } = metric

     // Round values to 2 decimal places
     const roundedValue = Math.round(value)

     event({
       action: name,
       category: 'Web Vitals',
       label: id,
       value: roundedValue,
     })

     // Also send as custom event with rating
     if (typeof window.gtag !== 'undefined') {
       window.gtag('event', name, {
         value: roundedValue,
         metric_id: id,
         metric_rating: rating, // 'good', 'needs-improvement', 'poor'
         metric_delta: Math.round(metric.delta),
       })
     }
   }

   // Get performance rating based on thresholds
   export function getPerformanceRating(metric: Metric): 'good' | 'needs-improvement' | 'poor' {
     const { name, value } = metric

     const thresholds = {
       CLS: { good: 0.1, poor: 0.25 },
       FID: { good: 100, poor: 300 },
       LCP: { good: 2500, poor: 4000 },
       FCP: { good: 1800, poor: 3000 },
       TTFB: { good: 800, poor: 1800 },
       INP: { good: 200, poor: 500 },
     }

     const threshold = thresholds[name as keyof typeof thresholds]
     if (!threshold) return 'good'

     if (value <= threshold.good) return 'good'
     if (value <= threshold.poor) return 'needs-improvement'
     return 'poor'
   }

   // Log to console in development
   export function logWebVital(metric: Metric) {
     if (process.env.NODE_ENV === 'development') {
       const rating = getPerformanceRating(metric)
       const color = rating === 'good' ? '\x1b[32m' : rating === 'needs-improvement' ? '\x1b[33m' : '\x1b[31m'
       console.log(
         `${color}%s\x1b[0m`,
         `[WebVitals] ${metric.name}: ${Math.round(metric.value)}ms (${rating})`
       )
     }
   }
   ```

**Verification:**
- [ ] `lib/performance.ts` created with web vitals helpers
- [ ] Functions handle all 6 core metrics (LCP, FID, CLS, FCP, TTFB, INP)
- [ ] TypeScript compiles without errors

</task>

<task id="2" name="Create WebVitals component">

**Action:** Create client component to capture and report web vitals

**Steps:**
1. Install web-vitals library:
   ```bash
   npm install web-vitals
   ```

2. Create `components/performance/WebVitals.tsx`:
   ```typescript
   'use client'

   import { useEffect } from 'react'
   import { onCLS, onFID, onFCP, onLCP, onTTFB, onINP, Metric } from 'web-vitals'
   import { sendToGA4, logWebVital } from '@/lib/performance'

   export default function WebVitals() {
     useEffect(() => {
       const handleMetric = (metric: Metric) => {
         // Log in development
         logWebVital(metric)

         // Send to GA4
         sendToGA4(metric)
       }

       // Measure all Core Web Vitals
       onCLS(handleMetric)
       onFID(handleMetric)
       onFCP(handleMetric)
       onLCP(handleMetric)
       onTTFB(handleMetric)
       onINP(handleMetric)
     }, [])

     return null // This component doesn't render anything
   }
   ```

**Verification:**
- [ ] `web-vitals` installed
- [ ] WebVitals component created
- [ ] All 6 metrics captured (CLS, FID, FCP, LCP, TTFB, INP)
- [ ] Component is client-side only ('use client')

</task>

<task id="3" name="Add WebVitals to root layout">

**Action:** Mount WebVitals component in app layout

**Steps:**
1. Update `app/layout.tsx`:
   ```typescript
   import GoogleAnalytics from '@/components/analytics/GoogleAnalytics'
   import WebVitals from '@/components/performance/WebVitals'

   export default function RootLayout({
     children,
   }: {
     children: React.ReactNode
   }) {
     return (
       <html lang="en">
         <body>
           <GoogleAnalytics />
           <WebVitals />
           {children}
         </body>
       </html>
     )
   }
   ```

**Verification:**
- [ ] WebVitals added to root layout
- [ ] Component mounts on initial page load
- [ ] No visual changes (component renders nothing)

</task>

<task id="4" name="Create performance dashboard query">

**Action:** Document GA4 queries for performance monitoring

**Steps:**
1. Create `docs/performance-monitoring.md`:
   ```markdown
   # Performance Monitoring Guide

   ## Core Web Vitals in GA4

   ### Custom Exploration Query

   1. Go to GA4 → Explore → Create custom exploration
   2. Add dimensions:
      - Event name
      - Metric rating
   3. Add metrics:
      - Event count
      - Average event value
   4. Filter by event name contains: "CLS", "FID", "LCP", "FCP", "TTFB", "INP"

   ### Expected Values (Targets)

   | Metric | Good | Needs Improvement | Poor | Current Target |
   |--------|------|-------------------|------|----------------|
   | LCP    | <2.5s | 2.5-4s | >4s | <3s (Phase 5 goal) |
   | FID    | <100ms | 100-300ms | >300ms | <100ms |
   | CLS    | <0.1 | 0.1-0.25 | >0.25 | <0.1 |
   | FCP    | <1.8s | 1.8-3s | >3s | <2s |
   | TTFB   | <800ms | 800-1800ms | >1800ms | <1s |
   | INP    | <200ms | 200-500ms | >500ms | <200ms |

   ### Real-Time Monitoring

   Navigate to: GA4 → Reports → Realtime → Event name filter = "LCP" (or other metrics)

   ### Setting Up Alerts

   1. Go to GA4 → Configure → Custom Definitions → Create custom metrics
   2. Create metric for each Web Vital (LCP, FID, CLS, etc.)
   3. Set up alerts in GA4 → Admin → Data Display → Custom Alerts
   4. Alert condition: "Average LCP > 3000ms for 7 days"

   ## Development Monitoring

   Web Vitals are logged to console in development mode:

   ```
   [WebVitals] LCP: 2341ms (good)
   [WebVitals] FID: 12ms (good)
   [WebVitals] CLS: 0.002 (good)
   ```

   ## Production Verification

   After deployment:
   1. Visit production site
   2. Open GA4 real-time reports
   3. Verify Web Vitals events appearing
   4. Check metric values against targets
   ```

**Verification:**
- [ ] Documentation created with GA4 query instructions
- [ ] Expected value table includes all 6 metrics
- [ ] Development console logging documented

</task>

## Verification Criteria

**Functional Requirements:**
- [ ] Web vitals measured for all 6 metrics (CLS, FID, FCP, LCP, TTFB, INP)
- [ ] Metrics sent to GA4 with rating ('good', 'needs-improvement', 'poor')
- [ ] Development console shows metric values
- [ ] No impact on page performance (web-vitals library is <3KB)

**Performance Requirements:**
- [ ] web-vitals library adds <3KB to bundle
- [ ] Metrics collected without blocking main thread
- [ ] No CLS caused by monitoring code itself

**Data Quality:**
- [ ] Metric values match Chrome DevTools Performance tab
- [ ] Ratings calculated correctly per Google thresholds
- [ ] GA4 events include metric_id, metric_rating, metric_delta

## Must-Haves (Goal-Backward Verification)

From Phase 6 success criteria:

1. **Score Met:** Lighthouse Performance >85, Accessibility >90
   - [ ] LCP measured and tracked
   - [ ] FID/INP measured and tracked
   - [ ] CLS measured and tracked
   - [ ] TTFB measured and tracked
   - [ ] All metrics sent to GA4

2. **Bundle Met:** Total Blocking Time <300ms, bundle <220KB
   - [ ] web-vitals library <3KB
   - [ ] No blocking during metric collection
   - [ ] Bundle size still under 220KB target

## Notes

- Uses official `web-vitals` library from Google Chrome team
- Metrics collected passively without user interaction
- Development logging helps catch regressions early
- GA4 custom metrics allow setting up automated alerts
- INP replaces FID as of March 2024 (measure both for transition)

## Dependencies

- Plan 06-01 complete (GA4 integration)
- `web-vitals` npm package

## Estimated Impact

**Bundle Size:** +2-3KB (web-vitals library)
**Performance:** None (passive measurement)
**Complexity:** Low (built-in Next.js support)
