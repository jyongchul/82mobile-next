---
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - next.config.js
  - lighthouse-ci.config.js
  - .github/workflows/lighthouse.yml
autonomous: false
checkpoint: after_task_2
---

# Plan 06-03: Lighthouse CI Automation

## Objective

Set up automated Lighthouse audits in CI/CD pipeline to catch performance regressions before deployment and verify Phase 6 success criteria.

## Context

**Current State:**
- Manual Lighthouse audits only (Phase 5 baseline)
- Chrome unavailable in WSL (limits local testing)
- Production deployment via Vercel
- Performance baseline: 118-125KB bundles, LCP ~2.0-2.5s

**Phase 6 Targets:**
- Lighthouse Performance >85
- Lighthouse Accessibility >90
- Total Blocking Time <300ms
- Bundle <220KB

## Tasks

<task id="1" name="Install Lighthouse CI">

**Action:** Add Lighthouse CI as dev dependency and create configuration

**Steps:**
1. Install Lighthouse CI:
   ```bash
   npm install --save-dev @lhci/cli
   ```

2. Create `lighthouse-ci.config.js`:
   ```javascript
   module.exports = {
     ci: {
       collect: {
         // URLs to audit
         url: [
           'http://localhost:3000/en',
           'http://localhost:3000/en#products',
           'http://localhost:3000/en#about',
           'http://localhost:3000/en#contact',
         ],
         // Number of runs per URL
         numberOfRuns: 3,
         settings: {
           // Mobile emulation (Phase 5 mobile-first)
           preset: 'desktop', // Start with desktop, add mobile in separate run
           throttling: {
             // Simulated 3G
             rttMs: 150,
             throughputKbps: 1638.4,
             cpuSlowdownMultiplier: 4,
           },
         },
       },
       assert: {
         preset: 'lighthouse:recommended',
         assertions: {
           // Performance thresholds (Phase 6 goals)
           'categories:performance': ['error', { minScore: 0.85 }],
           'categories:accessibility': ['error', { minScore: 0.90 }],
           'categories:best-practices': ['warn', { minScore: 0.85 }],
           'categories:seo': ['warn', { minScore: 0.90 }],

           // Core Web Vitals (align with Phase 5 baseline)
           'largest-contentful-paint': ['error', { maxNumericValue: 3000 }],
           'cumulative-layout-shift': ['error', { maxNumericValue: 0.1 }],
           'total-blocking-time': ['error', { maxNumericValue: 300 }],

           // Resource hints
           'uses-rel-preconnect': 'off', // Not critical for single-page app
           'uses-http2': 'off', // Vercel handles this

           // Bundle size (Phase 5 baseline: 118-125KB)
           'total-byte-weight': ['warn', { maxNumericValue: 225000 }], // 220KB + 5KB buffer
         },
       },
       upload: {
         target: 'temporary-public-storage', // Free LHCI server for 7 days
       },
     },
   }
   ```

3. Add npm scripts to `package.json`:
   ```json
   {
     "scripts": {
       "lighthouse": "lhci autorun",
       "lighthouse:mobile": "lhci autorun --config=lighthouse-mobile.config.js"
     }
   }
   ```

**Verification:**
- [ ] `@lhci/cli` installed
- [ ] `lighthouse-ci.config.js` created with performance thresholds
- [ ] npm scripts added for running audits

</task>

<task id="2" name="Create GitHub Actions workflow">

**Action:** Set up automated Lighthouse audits on pull requests

**Steps:**
1. Create `.github/workflows/lighthouse.yml`:
   ```yaml
   name: Lighthouse CI

   on:
     pull_request:
       branches: [main, master]
     push:
       branches: [main, master]

   jobs:
     lighthouse:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v3

         - name: Setup Node.js
           uses: actions/setup-node@v3
           with:
             node-version: '18'
             cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Build Next.js
           run: npm run build
           env:
             # Use placeholder for build (GA4 optional)
             NEXT_PUBLIC_GA_MEASUREMENT_ID: 'G-XXXXXXXXXX'

         - name: Start Next.js server
           run: npm run start &
           env:
             PORT: 3000

         - name: Wait for server
           run: npx wait-on http://localhost:3000

         - name: Run Lighthouse CI
           run: npm run lighthouse
           env:
             LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

         - name: Upload results
           uses: actions/upload-artifact@v3
           if: always()
           with:
             name: lighthouse-results
             path: .lighthouseci
   ```

2. Add `.lighthouseci` to `.gitignore`:
   ```
   .lighthouseci/
   ```

**Verification:**
- [ ] GitHub Actions workflow created
- [ ] Workflow runs on PR and push to main
- [ ] Results uploaded as artifacts
- [ ] `.lighthouseci` ignored by git

</task>

## CHECKPOINT

**User Decision Required:** Lighthouse CI setup complete

**What's Been Done:**
- Lighthouse CI installed and configured
- Performance thresholds set (Performance >85, Accessibility >90)
- GitHub Actions workflow created for automated audits

**Options:**

**Option A: Run local audit now (Recommended if Chrome available)**
- Verify configuration works
- Get baseline Lighthouse scores
- Catch any issues before CI setup

**Option B: Trust CI setup, proceed to execution**
- Skip local testing (WSL limitation from Phase 5)
- Rely on GitHub Actions for first run
- Faster but less validation

**Option C: Deploy to Vercel preview first**
- Test against real deployment
- More accurate scores (no localhost variance)
- Requires PR creation

</task>

<task id="3" name="Run baseline audit">

**Action:** Execute Lighthouse audit to verify Phase 6 goals

**Steps:**
1. Build and start production server:
   ```bash
   npm run build
   npm run start
   ```

2. Run Lighthouse CI:
   ```bash
   npm run lighthouse
   ```

3. Review results in `.lighthouseci/` directory

4. Verify success criteria:
   - Performance score ≥85
   - Accessibility score ≥90
   - LCP <3000ms
   - TBT <300ms
   - CLS <0.1
   - Bundle <220KB

**Verification:**
- [ ] Build completes successfully
- [ ] Server starts on localhost:3000
- [ ] Lighthouse audit runs without errors
- [ ] All assertions pass (or document failures)
- [ ] Results saved to `.lighthouseci/` directory

</task>

<task id="4" name="Document results and create status badge">

**Action:** Create performance status documentation

**Steps:**
1. Create `docs/lighthouse-results.md`:
   ```markdown
   # Lighthouse Performance Results

   **Last Updated:** [DATE]
   **Commit:** [HASH]

   ## Desktop Results (3G Throttled)

   | Category | Score | Status |
   |----------|-------|--------|
   | Performance | [XX]/100 | [✅/❌] |
   | Accessibility | [XX]/100 | [✅/❌] |
   | Best Practices | [XX]/100 | [✅/❌] |
   | SEO | [XX]/100 | [✅/❌] |

   ## Core Web Vitals

   | Metric | Value | Target | Status |
   |--------|-------|--------|--------|
   | LCP | [X.XX]s | <3s | [✅/❌] |
   | TBT | [XXX]ms | <300ms | [✅/❌] |
   | CLS | [0.XXX] | <0.1 | [✅/❌] |

   ## Bundle Size

   | Route | First Load JS | Target | Status |
   |-------|---------------|--------|--------|
   | / (home) | [XXX] KB | <220KB | [✅/❌] |
   | /shop | [XXX] KB | <220KB | [✅/❌] |
   | /cart | [XXX] KB | <220KB | [✅/❌] |
   | /checkout | [XXX] KB | <220KB | [✅/❌] |

   ## Phase 6 Success Criteria

   - [ ] Bundle Met: TBT <300ms, bundle <220KB
   - [ ] Scroll Smooth: 60fps during scroll (manual testing required)
   - [ ] Score Met: Performance >85, Accessibility >90
   - [ ] Tracking Works: GA4 section views (Plan 06-01)
   - [ ] Funnel Tracked: GA4 e-commerce events (Plan 06-01)

   ## Recommendations

   [List any Lighthouse opportunities or diagnostics that need attention]

   ## CI/CD Integration

   - GitHub Actions workflow: `.github/workflows/lighthouse.yml`
   - Runs on: PR + push to main
   - Results: Check Actions tab for artifacts
   ```

2. Fill in actual values from audit results

3. Optional: Add Lighthouse badge to README.md:
   ```markdown
   [![Lighthouse Performance](https://img.shields.io/badge/lighthouse-85+-green.svg)](./docs/lighthouse-results.md)
   ```

**Verification:**
- [ ] `docs/lighthouse-results.md` created with actual scores
- [ ] All Phase 6 success criteria checked
- [ ] Recommendations documented (if any)
- [ ] Badge added to README (optional)

</task>

## Verification Criteria

**Functional Requirements:**
- [ ] Lighthouse CI installed and configured
- [ ] Audits run successfully on localhost
- [ ] GitHub Actions workflow triggers on PR
- [ ] Results uploaded and accessible

**Performance Requirements (Phase 6 Goals):**
- [ ] Performance score ≥85
- [ ] Accessibility score ≥90
- [ ] LCP <3000ms (3s target)
- [ ] TBT <300ms
- [ ] CLS <0.1
- [ ] Bundle <220KB

**CI/CD Integration:**
- [ ] Workflow runs automatically
- [ ] Failed audits block merge (optional, can configure)
- [ ] Results visible in PR comments or artifacts

## Must-Haves (Goal-Backward Verification)

From Phase 6 success criteria:

1. **Bundle Met:** Lighthouse shows Total Blocking Time <300ms, bundle <220KB
   - [ ] TBT assertion passes (<300ms)
   - [ ] total-byte-weight assertion passes (<220KB)

2. **Score Met:** Lighthouse Performance >85, Accessibility >90
   - [ ] Performance category score ≥85
   - [ ] Accessibility category score ≥90

3. **Scroll Smooth:** Chrome DevTools Performance shows consistent 60fps during scroll
   - [ ] Documented in lighthouse-results.md (manual testing)
   - [ ] No frame drops during smooth scroll

## Notes

- Uses temporary public storage (7-day retention) for CI results
- Can upgrade to LHCI server for permanent storage if needed
- Desktop audit first (mobile optimization already done in Phase 5)
- Assertions block on error, warn on non-critical issues
- Local audit requires Chrome (skip in WSL, use CI instead)

## Dependencies

- Node.js 18+ (for Lighthouse)
- GitHub repository (for Actions)
- Production build working (from Phase 5)

## Estimated Impact

**Bundle Size:** 0KB (dev dependency only)
**Performance:** None (CI-only, doesn't ship to production)
**Complexity:** Medium (CI/CD setup, GitHub Actions)
