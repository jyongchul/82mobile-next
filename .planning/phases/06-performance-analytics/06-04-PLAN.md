---
wave: 2
depends_on: [06-01]
files_modified:
  - next.config.js
  - app/[locale]/layout.tsx
autonomous: true
---

# Plan 06-04: Image and Font Optimization

## Objective

Optimize images with responsive sizes and implement font optimization using next/font to improve LCP and reduce CLS.

## Context

**Current State:**
- Next.js Image component used (configured in next.config.js)
- Google Fonts loaded via CDN (potential FOIT/FOUT)
- Product images from WooCommerce API
- Hero images static
- Current LCP estimate: 2.0-2.5s (Phase 5 baseline)

**Optimization Targets:**
- Reduce LCP by -200-300ms through font optimization
- Eliminate CLS from font swapping
- Optimize hero image loading (priority)
- Responsive image sizes for all viewports

## Tasks

<task id="1" name="Implement next/font for Google Fonts">

**Action:** Replace CDN font loading with next/font for automatic optimization

**Steps:**
1. Update `app/[locale]/layout.tsx` to use next/font:
   ```typescript
   import { Outfit, Plus_Jakarta_Sans } from 'next/font/google'

   // Font configurations
   const outfit = Outfit({
     subsets: ['latin'],
     display: 'swap',
     variable: '--font-heading',
     preload: true,
     fallback: ['system-ui', 'sans-serif'],
   })

   const plusJakarta = Plus_Jakarta_Sans({
     subsets: ['latin'],
     display: 'swap',
     variable: '--font-body',
     preload: true,
     fallback: ['system-ui', 'sans-serif'],
   })

   export default function RootLayout({
     children,
     params: { locale },
   }: {
     children: React.ReactNode
     params: { locale: string }
   }) {
     return (
       <html lang={locale} className={`${outfit.variable} ${plusJakarta.variable}`}>
         <body className="font-body">
           {children}
         </body>
       </html>
     )
   }
   ```

2. Update Tailwind config to use CSS variables:
   ```javascript
   // tailwind.config.ts
   module.exports = {
     theme: {
       extend: {
         fontFamily: {
           heading: ['var(--font-heading)'],
           body: ['var(--font-body)'],
         },
       },
     },
   }
   ```

3. Remove any CDN font links from layout or head

**Verification:**
- [ ] Fonts load from self-hosted files (check Network tab)
- [ ] No external requests to fonts.googleapis.com
- [ ] Fonts display immediately (no FOIT/FOUT)
- [ ] Font CSS variables available in Tailwind

</task>

<task id="2" name="Optimize hero image loading">

**Action:** Add priority loading to hero section images

**Steps:**
1. Update hero image in `components/home/Hero.tsx` (or similar):
   ```typescript
   import Image from 'next/image'

   // Hero background image
   <Image
     src="/images/hero/palace.jpg"
     alt="Seoul palace background"
     fill
     priority
     quality={85}
     sizes="100vw"
     className="object-cover"
   />
   ```

2. Verify image dimensions and format:
   ```bash
   # Check if WebP versions exist, create if needed
   npx @squoosh/cli --webp auto public/images/hero/*.jpg
   ```

3. Update next.config.js to prefer WebP:
   ```javascript
   module.exports = {
     images: {
       formats: ['image/webp', 'image/avif'],
       deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
       imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
     },
   }
   ```

**Verification:**
- [ ] Hero image has `priority` prop
- [ ] Image loads before LCP measurement
- [ ] WebP format served to supporting browsers
- [ ] No lazy loading delay on hero image

</task>

<task id="3" name="Optimize product images">

**Action:** Configure responsive sizes for product grid images

**Steps:**
1. Update ProductCard image sizes:
   ```typescript
   // components/shop/ProductCard.tsx
   <Image
     src={product.image}
     alt={product.name}
     width={400}
     height={400}
     sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
     quality={80}
     className="w-full h-full object-cover"
   />
   ```

2. Verify lazy loading enabled (default for non-priority images):
   ```typescript
   // Below-the-fold products should NOT have priority
   // Next.js will automatically lazy load them
   ```

3. Add blur placeholder for better UX:
   ```typescript
   <Image
     src={product.image}
     alt={product.name}
     width={400}
     height={400}
     sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
     quality={80}
     placeholder="blur"
     blurDataURL="data:image/svg+xml;base64,..." // Generate with plaiceholder or similar
     className="w-full h-full object-cover"
   />
   ```

**Verification:**
- [ ] Product images have responsive `sizes` attribute
- [ ] Images lazy load when scrolling
- [ ] Correct image sizes requested (check Network tab)
- [ ] Blur placeholder shows while loading

</task>

<task id="4" name="Add image loading="eager" for above-fold content">

**Action:** Ensure first 3-4 product cards load eagerly

**Steps:**
1. Update ProductGrid to prioritize above-fold images:
   ```typescript
   // components/shop/ProductGrid.tsx
   {products.map((product, index) => (
     <ProductCard
       key={product.id}
       product={product}
       priority={index < 4} // First 4 products (above fold)
     />
   ))}
   ```

2. Update ProductCard to accept priority prop:
   ```typescript
   // components/shop/ProductCard.tsx
   interface ProductCardProps {
     product: Product
     priority?: boolean
   }

   export default function ProductCard({ product, priority = false }: ProductCardProps) {
     return (
       <Image
         src={product.image}
         alt={product.name}
         width={400}
         height={400}
         priority={priority}
         loading={priority ? 'eager' : 'lazy'}
         // ... other props
       />
     )
   }
   ```

**Verification:**
- [ ] First 4 products have `priority={true}`
- [ ] First 4 products load immediately
- [ ] Remaining products lazy load on scroll
- [ ] No layout shift when images load

</task>

<task id="5" name="Verify font and image optimization impact">

**Action:** Measure performance improvement

**Steps:**
1. Build production version:
   ```bash
   npm run build
   ```

2. Compare bundle sizes:
   ```bash
   # Check if font files are self-hosted
   ls -lh .next/static/fonts/

   # Compare bundle size vs Phase 5 baseline (118-125KB)
   # Should be similar or slightly larger due to font files
   ```

3. Test in browser:
   - Check Network tab: fonts load from `/_next/static/fonts/`
   - Check Performance tab: LCP should improve by ~200-300ms
   - Check Layout Shift: CLS should be <0.1 (no font swap)

4. Document improvements:
   ```markdown
   ## Font Optimization Results

   **Before (CDN):**
   - FOIT/FOUT: 200-300ms font swap
   - CLS from font loading: 0.05-0.15
   - External requests: 2-4

   **After (next/font):**
   - No font swap (preloaded)
   - CLS from fonts: 0
   - Self-hosted (no external requests)
   - LCP improvement: -200ms estimated

   ## Image Optimization Results

   **Before:**
   - Hero image lazy loaded (wrong)
   - All product images lazy loaded
   - No responsive sizes

   **After:**
   - Hero image priority loaded
   - First 4 products eager loaded
   - Responsive sizes optimize bandwidth
   ```

**Verification:**
- [ ] Build completes successfully
- [ ] Font files in `.next/static/fonts/`
- [ ] LCP improved vs Phase 5 baseline
- [ ] CLS <0.1 (no font-related shifts)
- [ ] Bundle size still <220KB

</task>

## Verification Criteria

**Font Optimization:**
- [ ] Fonts self-hosted via next/font
- [ ] No external font requests (fonts.googleapis.com)
- [ ] `font-display: swap` used
- [ ] Fallback fonts specified
- [ ] No FOIT (Flash of Invisible Text)
- [ ] No FOUT (Flash of Unstyled Text)

**Image Optimization:**
- [ ] Hero image has `priority` prop
- [ ] Product images have responsive `sizes`
- [ ] First 4 products load eagerly
- [ ] Below-fold images lazy load
- [ ] WebP format served to supporting browsers
- [ ] No CLS from image loading

**Performance Impact:**
- [ ] LCP reduced by ~200-300ms
- [ ] CLS from fonts eliminated
- [ ] Bundle size still <220KB
- [ ] No regression in other metrics

## Must-Haves (Goal-Backward Verification)

From Phase 6 success criteria:

1. **Score Met:** Lighthouse Performance >85
   - [ ] Font optimization contributes to performance score
   - [ ] Image optimization reduces LCP
   - [ ] No CLS penalty from fonts

2. **Bundle Met:** TBT <300ms, bundle <220KB
   - [ ] Font files self-hosted but not counted in bundle
   - [ ] Image optimization doesn't affect bundle size
   - [ ] Total bundle still under 220KB

## Notes

- `next/font` automatically optimizes font loading
- `font-display: swap` prevents invisible text
- Fallback fonts minimize CLS
- Hero image `priority` critical for LCP
- Responsive image `sizes` reduce bandwidth
- First 4 products above fold on desktop (3-column grid)
- WebP format reduces image size by ~30%

## Dependencies

- Next.js 14 with App Router
- Google Fonts (Outfit, Plus Jakarta Sans)
- Existing Image component usage

## Estimated Impact

**LCP Improvement:** -200-300ms (font preloading + hero priority)
**CLS Reduction:** -0.05-0.15 (font swap eliminated)
**Bundle Size:** +0KB (fonts are separate, not bundled)
**Bandwidth Savings:** -20-30% (WebP images)
**Complexity:** Low (Next.js handles optimization)
