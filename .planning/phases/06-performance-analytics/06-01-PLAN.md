---
wave: 1
depends_on: []
files_modified:
  - next.config.js
  - app/layout.tsx
  - lib/analytics.ts
  - components/analytics/GoogleAnalytics.tsx
autonomous: true
---

# Plan 06-01: Google Analytics 4 Integration

## Objective

Integrate GA4 with Next.js App Router to track page views, section views, and core conversion events (product_view, add_to_cart, begin_checkout, purchase).

## Context

**Current State:**
- No analytics currently integrated
- Single-page app with smooth scroll navigation
- Section-based navigation (hero, products, about, contact)
- WooCommerce order flow complete

**Technical Constraints:**
- Must work with Next.js App Router (not Pages Router)
- Must respect GDPR/privacy (no tracking before consent)
- Must minimize performance impact (<5KB bundle addition)
- Must track virtual page views for single-page sections

## Tasks

<task id="1" name="Create GA4 configuration">

**Action:** Set up GA4 measurement ID and create analytics utility module

**Steps:**
1. Add GA4 measurement ID to environment variables:
   ```bash
   # .env.local
   NEXT_PUBLIC_GA_MEASUREMENT_ID=G-XXXXXXXXXX
   ```

2. Create `lib/analytics.ts`:
   ```typescript
   // Google Analytics 4 helper functions
   // NOTE: Uses window.gtag (loaded from external GA script), not dangerouslySetInnerHTML

   export const GA_MEASUREMENT_ID = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID

   // Page view tracking
   export const pageview = (url: string, title: string) => {
     if (typeof window.gtag !== 'undefined') {
       window.gtag('config', GA_MEASUREMENT_ID, {
         page_path: url,
         page_title: title,
       })
     }
   }

   // Event tracking
   type GTagEvent = {
     action: string
     category: string
     label?: string
     value?: number
   }

   export const event = ({ action, category, label, value }: GTagEvent) => {
     if (typeof window.gtag !== 'undefined') {
       window.gtag('event', action, {
         event_category: category,
         event_label: label,
         value: value,
       })
     }
   }

   // E-commerce events
   export const trackProductView = (product: {
     id: string
     name: string
     price: number
     category?: string
   }) => {
     if (typeof window.gtag !== 'undefined') {
       window.gtag('event', 'view_item', {
         currency: 'KRW',
         value: product.price,
         items: [{
           item_id: product.id,
           item_name: product.name,
           item_category: product.category,
           price: product.price,
         }]
       })
     }
   }

   export const trackAddToCart = (product: {
     id: string
     name: string
     price: number
     quantity: number
   }) => {
     if (typeof window.gtag !== 'undefined') {
       window.gtag('event', 'add_to_cart', {
         currency: 'KRW',
         value: product.price * product.quantity,
         items: [{
           item_id: product.id,
           item_name: product.name,
           price: product.price,
           quantity: product.quantity,
         }]
       })
     }
   }

   export const trackBeginCheckout = (value: number, items: any[]) => {
     if (typeof window.gtag !== 'undefined') {
       window.gtag('event', 'begin_checkout', {
         currency: 'KRW',
         value: value,
         items: items,
       })
     }
   }

   export const trackPurchase = (orderId: string, value: number, items: any[]) => {
     if (typeof window.gtag !== 'undefined') {
       window.gtag('event', 'purchase', {
         transaction_id: orderId,
         currency: 'KRW',
         value: value,
         items: items,
       })
     }
   }
   ```

3. Add TypeScript types:
   ```typescript
   // types/gtag.d.ts
   declare global {
     interface Window {
       gtag: (
         command: 'config' | 'event' | 'js' | 'set',
         targetId: string,
         config?: Record<string, any>
       ) => void
       dataLayer: any[]
     }
   }

   export {}
   ```

**Verification:**
- [ ] `.env.local` has GA_MEASUREMENT_ID
- [ ] `lib/analytics.ts` exports all tracking functions
- [ ] TypeScript compiles without errors

</task>

<task id="2" name="Add GA4 script to layout">

**Action:** Create GoogleAnalytics component and add to root layout

**Steps:**
1. Create `components/analytics/GoogleAnalytics.tsx`:
   ```typescript
   'use client'

   import Script from 'next/script'
   import { GA_MEASUREMENT_ID } from '@/lib/analytics'

   export default function GoogleAnalytics() {
     if (!GA_MEASUREMENT_ID) {
       return null
     }

     return (
       <>
         <Script
           strategy="afterInteractive"
           src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}
         />
         <Script
           id="google-analytics"
           strategy="afterInteractive"
         >
           {`
             window.dataLayer = window.dataLayer || [];
             function gtag(){dataLayer.push(arguments);}
             gtag('js', new Date());
             gtag('config', '${GA_MEASUREMENT_ID}', {
               page_path: window.location.pathname,
             });
           `}
         </Script>
       </>
     )
   }
   ```

2. Add to `app/layout.tsx`:
   ```typescript
   import GoogleAnalytics from '@/components/analytics/GoogleAnalytics'

   export default function RootLayout({
     children,
   }: {
     children: React.ReactNode
   }) {
     return (
       <html lang="en">
         <body>
           <GoogleAnalytics />
           {children}
         </body>
       </html>
     )
   }
   ```

**Verification:**
- [ ] GoogleAnalytics component created
- [ ] Component added to root layout
- [ ] Script loads with `strategy="afterInteractive"`
- [ ] No console errors in browser

</task>

<task id="3" name="Track section views with Intersection Observer">

**Action:** Add section view tracking to existing navigation system

**Steps:**
1. Update `lib/hooks/useScrollNavigation.ts` to track section views:
   ```typescript
   import { pageview } from '@/lib/analytics'

   // Inside useScrollNavigation hook, when active section changes:
   useEffect(() => {
     if (activeSection) {
       // Track virtual page view for section
       pageview(
         `/#${activeSection}`,
         `82Mobile - ${activeSection.charAt(0).toUpperCase() + activeSection.slice(1)}`
       )
     }
   }, [activeSection])
   ```

**Verification:**
- [ ] Section changes trigger GA4 page views
- [ ] Page views visible in GA4 real-time reports
- [ ] Virtual page paths use `/#section-name` format

</task>

<task id="4" name="Track e-commerce events">

**Action:** Add event tracking to product interactions and checkout flow

**Steps:**
1. Track product view in `components/shop/ProductCard.tsx`:
   ```typescript
   import { trackProductView } from '@/lib/analytics'

   // When product card is expanded/viewed
   const handleView = () => {
     trackProductView({
       id: product.id.toString(),
       name: product.name,
       price: product.price,
       category: product.categories[0]?.name,
     })
   }
   ```

2. Track add to cart in `stores/cart.ts`:
   ```typescript
   import { trackAddToCart } from '@/lib/analytics'

   // In addItem action
   addItem: (product) => {
     // ... existing code ...

     trackAddToCart({
       id: product.id.toString(),
       name: product.name,
       price: product.price,
       quantity: 1,
     })
   }
   ```

3. Track begin checkout in `components/cart/CartDrawerCheckout.tsx`:
   ```typescript
   import { trackBeginCheckout } from '@/lib/analytics'

   // When checkout view opens
   useEffect(() => {
     if (isCheckoutView) {
       const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0)
       const cartItems = items.map(item => ({
         item_id: item.productId.toString(),
         item_name: item.name,
         price: item.price,
         quantity: item.quantity,
       }))

       trackBeginCheckout(total, cartItems)
     }
   }, [isCheckoutView, items])
   ```

4. Track purchase in `app/[locale]/order-complete/page.tsx`:
   ```typescript
   import { trackPurchase } from '@/lib/analytics'

   // When order complete page loads
   useEffect(() => {
     if (order) {
       const items = order.line_items.map(item => ({
         item_id: item.product_id.toString(),
         item_name: item.name,
         price: parseFloat(item.price),
         quantity: item.quantity,
       }))

       trackPurchase(
         order.id.toString(),
         parseFloat(order.total),
         items
       )
     }
   }, [order])
   ```

**Verification:**
- [ ] Product views tracked when cards expanded
- [ ] Add to cart events tracked with product details
- [ ] Begin checkout tracked when checkout opens
- [ ] Purchase tracked on order complete page
- [ ] All events visible in GA4 real-time reports

</task>

## Verification Criteria

**Functional Requirements:**
- [ ] GA4 script loads without errors
- [ ] Section views tracked as virtual page views
- [ ] Product view events fire with correct data
- [ ] Add to cart events fire with correct data
- [ ] Begin checkout events fire with correct data
- [ ] Purchase events fire with correct data

**Performance Requirements:**
- [ ] GA4 script loads with `strategy="afterInteractive"` (not blocking)
- [ ] No impact on LCP (<50ms added)
- [ ] No console errors or warnings

**Data Quality:**
- [ ] Real-time reports show events in GA4 dashboard
- [ ] E-commerce events include currency, value, items
- [ ] Product IDs match WooCommerce product IDs

## Must-Haves (Goal-Backward Verification)

From Phase 6 success criteria:

1. **Tracking Works:** GA4 shows page views for each section
   - [ ] Section navigation tracked as virtual page views
   - [ ] GA4 real-time reports show section views

2. **Funnel Tracked:** GA4 tracks product_view → add_to_cart → begin_checkout → purchase
   - [ ] `view_item` event fires when product viewed
   - [ ] `add_to_cart` event fires when item added to cart
   - [ ] `begin_checkout` event fires when checkout opens
   - [ ] `purchase` event fires on order complete
   - [ ] All events include proper e-commerce data (items, value, currency)

## Notes

- Uses Next.js Script component for optimal loading
- `strategy="afterInteractive"` ensures GA doesn't block page load
- Virtual page views needed for single-page app
- E-commerce events follow GA4 recommended format
- No PII (personally identifiable information) tracked
- GDPR consent handling deferred to Phase 6 Plan 03

## Dependencies

- Existing smooth scroll navigation system
- Existing cart store (Zustand)
- Existing product components
- Existing checkout flow

## Estimated Impact

**Bundle Size:** +3-5KB (gtag.js loaded async)
**Performance:** Minimal (<50ms added to page load)
**Complexity:** Low (standard GA4 integration)
