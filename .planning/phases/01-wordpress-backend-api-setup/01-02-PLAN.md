---
phase: 01-wordpress-backend-api-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - wp-content/plugins/cart-rest-api-for-woocommerce/ (installed via WP Admin)
  - .htaccess (update CORS headers to add CoCart-API-Cart-Key)
  - .planning/phases/01-wordpress-backend-api-setup/API-AUTH-DOCS.md
autonomous: false

must_haves:
  truths:
    - "CoCart plugin installed and activated; /wp-json/cocart/v2/cart endpoint accessible"
    - "Adding item to cart via CoCart API returns cart token in response headers"
    - "Cart persists across requests using CoCart-API-Cart-Key header"
    - "API authentication flow documented for Next.js frontend development"
  artifacts:
    - path: ".planning/phases/01-wordpress-backend-api-setup/API-AUTH-DOCS.md"
      provides: "JWT token flow, WooCommerce auth, CoCart usage documentation"
      contains: "jwt-auth/v1/token"
  key_links:
    - from: "CoCart API"
      to: "WooCommerce sessions"
      via: "Database-backed cart sessions"
      pattern: "cocart/v2/cart"
    - from: "CORS headers (.htaccess)"
      to: "CoCart API"
      via: "CoCart-API-Cart-Key in Access-Control-Allow-Headers"
      pattern: "CoCart-API-Cart-Key"
---

<objective>
Install CoCart plugin for headless cart sessions, update .htaccess CORS to include CoCart header, and create API authentication documentation covering JWT tokens, WooCommerce consumer keys, and CoCart cart operations.

Purpose: CoCart enables headless cart management that WooCommerce REST API alone cannot provide. Documentation ensures Phase 3 (Next.js API routes) can integrate without guesswork.
Output: Working CoCart endpoints with CORS support and comprehensive API auth documentation.
</objective>

<execution_context>
@/home/charles_lee/.claude/get-shit-done/workflows/execute-plan.md
@/home/charles_lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-wordpress-backend-api-setup/01-RESEARCH.md
@.planning/phases/01-wordpress-backend-api-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CoCart plugin, update CORS headers, verify cart operations</name>
  <files>
    wp-content/plugins/cart-rest-api-for-woocommerce/ (via WP Admin plugin install)
    .htaccess (update CORS headers via FTP)
  </files>
  <action>
    **Pre-check: Verify credentials file exists:**
    - Check that /mnt/c/82Mobile/WOOCOMMERCE_API_KEYS_PRODUCTION.txt exists and contains consumer key/secret
    - If missing, generate new keys via Playwright: WP Admin > WooCommerce > Settings > Advanced > REST API > Add Key (Read/Write, user: whadmin)
    - Store keys locally for use in API tests below

    1. **Install CoCart via Playwright browser automation:**
       - Login to http://82mobile.com/wp-admin (whadmin / WhMkt2026!@AdamKorSim)
       - Navigate to Plugins > Add New
       - Search "CoCart" (full name: "CoCart - Headless eCommerce API for Developers")
       - Install and Activate

    2. **Update .htaccess CORS to include CoCart header:**
       - Download current .htaccess via FTP
       - Find the Access-Control-Allow-Headers line (deployed in Plan 01-01)
       - Update it to: `Header set Access-Control-Allow-Headers "Authorization, Content-Type, CoCart-API-Cart-Key, X-Requested-With"`
       - Upload modified .htaccess via FTP

    3. **Test CoCart endpoints with curl:**
       ```bash
       # Get empty cart
       curl -s http://82mobile.com/wp-json/cocart/v2/cart

       # Get a product ID first
       PRODUCT_ID=$(curl -s "http://82mobile.com/wp-json/wc/v3/products?per_page=1" -u "CONSUMER_KEY:CONSUMER_SECRET" | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['id'])")

       # Add item to cart
       curl -s -X POST http://82mobile.com/wp-json/cocart/v2/cart/add-item \
         -H "Content-Type: application/json" \
         -d "{\"id\":\"$PRODUCT_ID\",\"quantity\":\"1\"}" \
         -D - | grep -i "cocart-api-cart-key"

       # Use cart token to retrieve cart
       CART_TOKEN="{from previous response header}"
       curl -s http://82mobile.com/wp-json/cocart/v2/cart \
         -H "CoCart-API-Cart-Key: $CART_TOKEN"
       ```

    4. **Test CORS works for CoCart with the updated header:**
       ```bash
       curl -s -I -X OPTIONS http://82mobile.com/wp-json/cocart/v2/cart \
         -H "Origin: https://82mobile-next.vercel.app" \
         -H "Access-Control-Request-Method: POST" \
         -H "Access-Control-Request-Headers: Content-Type,CoCart-API-Cart-Key"
       ```
       Verify Access-Control-Allow-Headers includes CoCart-API-Cart-Key.

       **If CORS test fails** (Gabia caching .htaccess): Install "CoCart CORS" addon plugin via Playwright as fallback:
       - Plugins > Add New > Search "CoCart CORS" > Install > Activate
       - Re-test CORS preflight
  </action>
  <verify>
    1. `curl -s http://82mobile.com/wp-json/cocart/v2/cart` returns JSON (not 404)
    2. Adding item returns CoCart-API-Cart-Key in response headers
    3. Cart retrieval with token returns the added item
    4. CORS OPTIONS for CoCart endpoint returns Access-Control-Allow-Headers containing CoCart-API-Cart-Key (via .htaccess update OR CoCart CORS plugin fallback)
  </verify>
  <done>
    CoCart installed, activated, CORS updated, and verified: cart creation, item addition, and token-based retrieval all work via API. CORS preflight passes for CoCart headers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create API authentication documentation</name>
  <files>.planning/phases/01-wordpress-backend-api-setup/API-AUTH-DOCS.md</files>
  <action>
    Create API documentation with the following 5 sections. Each section MUST include at least one working curl example with actual endpoint URLs.

    1. **JWT Authentication Flow:**
       - Token generation: POST /wp-json/jwt-auth/v1/token with {username, password} body
       - Token usage: `Authorization: Bearer {token}` header on subsequent requests
       - Token validation: POST /wp-json/jwt-auth/v1/token/validate
       - Token expiration: Default 7 days; recommend 24h for this project (note: requires filter to change)
       - Curl example: Full token request and authenticated API call

    2. **WooCommerce Consumer Key Authentication:**
       - When to use: Server-to-server requests (Next.js API routes to WordPress)
       - How: Basic Auth with `consumer_key:consumer_secret` OR query params `?consumer_key=ck_xxx&consumer_secret=cs_xxx`
       - Security: Keys stored in env vars, NEVER in frontend code; use HTTPS in production
       - Curl example: Fetch products with consumer key auth

    3. **CoCart Cart Operations:**
       - Cart creation: Automatic on first add-item call
       - Cart token: `CoCart-API-Cart-Key` response header; store in cookie or localStorage on client
       - Endpoints table: add-item (POST), cart (GET), cart/item/{key} (PUT for update, DELETE for remove), cart/clear (POST)
       - Session persistence: Database-backed via WooCommerce sessions table
       - Curl example: Add item, retrieve cart with token

    4. **CORS Configuration:**
       - Current allowed origin: `https://82mobile-next.vercel.app`
       - For local dev: Add `http://localhost:3000` to .htaccess Allow-Origin (or use CoCart CORS plugin)
       - Required headers per endpoint type (Authorization for JWT, CoCart-API-Cart-Key for cart)
       - How to modify: Edit .htaccess CORS block deployed in Plan 01-01

    5. **Environment Variables for Next.js (Phase 3):**
       ```
       WORDPRESS_API_URL=http://82mobile.com
       WC_CONSUMER_KEY=ck_xxx
       WC_CONSUMER_SECRET=cs_xxx
       JWT_USERNAME=whadmin
       JWT_PASSWORD=xxx
       NEXT_PUBLIC_WORDPRESS_URL=http://82mobile.com (client-safe, no secrets)
       ```

    Total: ~150-250 lines. This is the primary reference for Phase 3.
  </action>
  <verify>
    1. File exists at .planning/phases/01-wordpress-backend-api-setup/API-AUTH-DOCS.md
    2. Contains all 5 section headers (grep for "JWT Authentication", "WooCommerce Consumer", "CoCart Cart", "CORS Configuration", "Environment Variables")
    3. Contains at least 3 curl examples (grep for "curl -s")
    4. Contains env var block with WORDPRESS_API_URL, WC_CONSUMER_KEY, WC_CONSUMER_SECRET
  </verify>
  <done>
    API authentication documentation complete with all 5 sections, working curl examples, and env var specifications for Phase 3.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>CoCart headless cart and API documentation for the full Phase 1 setup</what-built>
  <how-to-verify>
    1. Visit http://82mobile.com/wp-admin > Plugins -- CoCart should be active
    2. Try adding a product to cart via the test curl command in the documentation
    3. Skim API-AUTH-DOCS.md to confirm it covers what you need for Next.js integration
    4. Verify customer admin account (adam82mob0105) can still manage products in WP Admin
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Complete Phase 1 verification -- all 5 success criteria from ROADMAP.md:
1. `curl -s -o /dev/null -w "%{http_code}" http://82mobile.com/` returns 404
2. `curl -s "http://82mobile.com/wp-json/wc/v3/products" -u "KEY:SECRET"` returns product JSON
3. `curl -s -I -X OPTIONS http://82mobile.com/wp-json/wc/v3/products -H "Origin: https://82mobile-next.vercel.app"` includes CORS headers
4. `curl -s -X POST http://82mobile.com/wp-json/jwt-auth/v1/token -H "Content-Type: application/json" -d '{"username":"whadmin","password":"WhMkt2026!@AdamKorSim"}'` returns token
5. `curl -s http://82mobile.com/wp-json/cocart/v2/cart` returns cart JSON
</verification>

<success_criteria>
- CoCart installed and operational with cart token persistence
- .htaccess CORS updated to include CoCart-API-Cart-Key header
- API documentation complete for Phase 3 handoff
- All Phase 1 ROADMAP success criteria met
- Requirements covered: BACKEND-05, BACKEND-08
</success_criteria>

<output>
After completion, create `.planning/phases/01-wordpress-backend-api-setup/01-02-SUMMARY.md`
</output>
