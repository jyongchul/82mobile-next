---
phase: 01-wordpress-backend-api-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - wp-content/plugins/cart-rest-api-for-woocommerce/ (installed via WP Admin)
  - .planning/phases/01-wordpress-backend-api-setup/API-AUTH-DOCS.md
autonomous: false

must_haves:
  truths:
    - "CoCart plugin installed and activated; /wp-json/cocart/v2/cart endpoint accessible"
    - "Adding item to cart via CoCart API returns cart token in response headers"
    - "Cart persists across requests using CoCart-API-Cart-Key header"
    - "API authentication flow documented for Next.js frontend development"
  artifacts:
    - path: ".planning/phases/01-wordpress-backend-api-setup/API-AUTH-DOCS.md"
      provides: "JWT token flow, WooCommerce auth, CoCart usage documentation"
      contains: "jwt-auth/v1/token"
  key_links:
    - from: "CoCart API"
      to: "WooCommerce sessions"
      via: "Database-backed cart sessions"
      pattern: "cocart/v2/cart"
    - from: "CORS headers (.htaccess)"
      to: "CoCart API"
      via: "CoCart-API-Cart-Key in Access-Control-Allow-Headers"
      pattern: "CoCart-API-Cart-Key"
---

<objective>
Install CoCart plugin for headless cart sessions and create API authentication documentation covering JWT tokens, WooCommerce consumer keys, and CoCart cart operations.

Purpose: CoCart enables headless cart management that WooCommerce REST API alone cannot provide. Documentation ensures Phase 3 (Next.js API routes) can integrate without guesswork.
Output: Working CoCart endpoints and comprehensive API auth documentation.
</objective>

<execution_context>
@/home/charles_lee/.claude/get-shit-done/workflows/execute-plan.md
@/home/charles_lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-wordpress-backend-api-setup/01-RESEARCH.md
@.planning/phases/01-wordpress-backend-api-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CoCart plugin and verify cart operations</name>
  <files>
    wp-content/plugins/cart-rest-api-for-woocommerce/ (via WP Admin plugin install)
  </files>
  <action>
    1. **Install CoCart via Playwright browser automation:**
       - Login to http://82mobile.com/wp-admin (whadmin / WhMkt2026!@AdamKorSim)
       - Navigate to Plugins > Add New
       - Search "CoCart" (full name: "CoCart - Headless eCommerce API for Developers")
       - Install and Activate
       - Optionally install "CoCart CORS" addon if .htaccess CORS from Plan 01 needs reinforcement

    2. **Test CoCart endpoints with curl:**
       ```bash
       # Get empty cart
       curl -s http://82mobile.com/wp-json/cocart/v2/cart

       # Get a product ID first
       PRODUCT_ID=$(curl -s "http://82mobile.com/wp-json/wc/v3/products?per_page=1" -u "CONSUMER_KEY:CONSUMER_SECRET" | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['id'])")

       # Add item to cart
       curl -s -X POST http://82mobile.com/wp-json/cocart/v2/cart/add-item \
         -H "Content-Type: application/json" \
         -d "{\"id\":\"$PRODUCT_ID\",\"quantity\":\"1\"}" \
         -D - | grep -i "cocart-api-cart-key"

       # Use cart token to retrieve cart
       CART_TOKEN="{from previous response header}"
       curl -s http://82mobile.com/wp-json/cocart/v2/cart \
         -H "CoCart-API-Cart-Key: $CART_TOKEN"
       ```

    3. **Test CORS works for CoCart** (CoCart-API-Cart-Key header must be in allowed headers -- already configured in Plan 01 .htaccess):
       ```bash
       curl -s -I -X OPTIONS http://82mobile.com/wp-json/cocart/v2/cart \
         -H "Origin: https://82mobile-next.vercel.app" \
         -H "Access-Control-Request-Method: POST" \
         -H "Access-Control-Request-Headers: Content-Type,CoCart-API-Cart-Key"
       ```
       Verify Access-Control-Allow-Headers includes CoCart-API-Cart-Key.

    Get WooCommerce consumer key/secret from /mnt/c/82Mobile/WOOCOMMERCE_API_KEYS_PRODUCTION.txt for authenticated requests.
  </action>
  <verify>
    1. `curl -s http://82mobile.com/wp-json/cocart/v2/cart` returns JSON (not 404)
    2. Adding item returns CoCart-API-Cart-Key in response headers
    3. Cart retrieval with token returns the added item
    4. CORS OPTIONS for CoCart endpoint returns proper headers
  </verify>
  <done>
    CoCart installed, activated, and verified: cart creation, item addition, and token-based retrieval all work via API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create API authentication documentation</name>
  <files>.planning/phases/01-wordpress-backend-api-setup/API-AUTH-DOCS.md</files>
  <action>
    Create comprehensive API documentation covering:

    1. **JWT Authentication Flow:**
       - Token generation: POST /wp-json/jwt-auth/v1/token with credentials
       - Token usage: Authorization: Bearer {token} header
       - Token validation: POST /wp-json/jwt-auth/v1/token/validate
       - Token expiration and refresh strategy (recommend 24h tokens for this project)

    2. **WooCommerce Consumer Key Authentication:**
       - When to use: Server-to-server requests (Next.js API routes to WordPress)
       - How: Basic Auth header with consumer_key:consumer_secret
       - Where keys are stored: environment variables (never in frontend code)

    3. **CoCart Cart Operations:**
       - Cart creation: Automatic on first add-item call
       - Cart token: CoCart-API-Cart-Key header from response, store in localStorage
       - Endpoints: add-item, cart, cart/item/{key} (update/delete), cart/clear
       - Session persistence: Database-backed, survives page reloads

    4. **CORS Configuration:**
       - Allowed origins (Vercel domain + localhost for dev)
       - Required headers for each endpoint type
       - How to add new origins (edit .htaccess)

    5. **Environment Variables Needed by Next.js (Phase 3):**
       - WORDPRESS_API_URL=http://82mobile.com
       - WC_CONSUMER_KEY=ck_xxx
       - WC_CONSUMER_SECRET=cs_xxx
       - JWT_USERNAME=whadmin (or create dedicated API user)
       - JWT_PASSWORD=xxx

    Include curl examples for every endpoint. This document will be the primary reference for Phase 3 development.
  </action>
  <verify>
    File exists at .planning/phases/01-wordpress-backend-api-setup/API-AUTH-DOCS.md with all 5 sections populated and curl examples included.
  </verify>
  <done>
    API authentication documentation complete, covering JWT, WooCommerce auth, CoCart, CORS, and env var requirements for Phase 3.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>CoCart headless cart and API documentation for the full Phase 1 setup</what-built>
  <how-to-verify>
    1. Visit http://82mobile.com/wp-admin > Plugins -- CoCart should be active
    2. Try adding a product to cart via the test curl command in the documentation
    3. Skim API-AUTH-DOCS.md to confirm it covers what you need for Next.js integration
    4. Verify customer admin account (adam82mob0105) can still manage products in WP Admin
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Complete Phase 1 verification -- all 5 success criteria from ROADMAP.md:
1. `curl -s -o /dev/null -w "%{http_code}" http://82mobile.com/` returns 404
2. `curl -s "http://82mobile.com/wp-json/wc/v3/products" -u "KEY:SECRET"` returns product JSON
3. `curl -s -I -X OPTIONS http://82mobile.com/wp-json/wc/v3/products -H "Origin: https://82mobile-next.vercel.app"` includes CORS headers
4. `curl -s -X POST http://82mobile.com/wp-json/jwt-auth/v1/token -H "Content-Type: application/json" -d '{"username":"whadmin","password":"WhMkt2026!@AdamKorSim"}'` returns token
5. `curl -s http://82mobile.com/wp-json/cocart/v2/cart` returns cart JSON
</verification>

<success_criteria>
- CoCart installed and operational with cart token persistence
- API documentation complete for Phase 3 handoff
- All Phase 1 ROADMAP success criteria met
- Requirements covered: BACKEND-05, BACKEND-08
</success_criteria>

<output>
After completion, create `.planning/phases/01-wordpress-backend-api-setup/01-02-SUMMARY.md`
</output>
