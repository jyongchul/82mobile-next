---
phase: 01-wordpress-backend-api-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .htaccess (WordPress root via FTP)
  - wp-config.php (WordPress root via FTP)
  - wp-content/mu-plugins/headless-mode.php (via FTP)
autonomous: false

must_haves:
  truths:
    - "WordPress public pages return 404 or redirect; only /wp-admin and /wp-json/ remain accessible"
    - "JWT Authentication plugin installed and activated; POST to /wp-json/jwt-auth/v1/token returns valid token"
    - "CORS preflight OPTIONS request from Vercel domain returns 200 with correct Access-Control headers"
    - "WooCommerce REST API responds to authenticated requests from external domain"
    - "API endpoints return no-cache headers (Cache-Control: no-store)"
  artifacts:
    - path: "wp-config.php"
      provides: "JWT_AUTH_SECRET_KEY and JWT_AUTH_CORS_ENABLE defines"
      contains: "JWT_AUTH_SECRET_KEY"
    - path: ".htaccess"
      provides: "Authorization header passthrough, CORS headers, API cache bypass"
      contains: "HTTP_AUTHORIZATION"
    - path: "wp-content/mu-plugins/headless-mode.php"
      provides: "Frontend redirect to 404 for non-admin non-API requests"
      contains: "template_redirect"
  key_links:
    - from: ".htaccess"
      to: "JWT plugin"
      via: "HTTP_AUTHORIZATION environment variable passthrough"
      pattern: "RewriteCond.*HTTP:Authorization"
    - from: "wp-config.php"
      to: "JWT plugin"
      via: "JWT_AUTH_SECRET_KEY define"
      pattern: "JWT_AUTH_SECRET_KEY"
---

<objective>
Configure WordPress at 82mobile.com as a headless API-only backend: disable frontend theme rendering, deploy server config files via FTP, install JWT authentication plugin, set up CORS headers for the Vercel domain, and ensure API endpoints bypass Gabia's server-level cache.

Purpose: WordPress must serve only as an API backend for the Next.js frontend. All public-facing pages will be handled by Next.js on Vercel.
Output: WordPress configured with headless mode, JWT auth, CORS, and cache bypass -- verified working via curl.
</objective>

<execution_context>
@/home/charles_lee/.claude/get-shit-done/workflows/execute-plan.md
@/home/charles_lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-wordpress-backend-api-setup/01-RESEARCH.md

Critical deployment info from project CLAUDE.md:
- FTP Host: 82mobile.com, Port 21, User: adam82mob0105, Pass: ssh82mobile2026!
- WordPress root is at / (FTP root), NOT /www_root/
- WP Admin: http://82mobile.com/wp-admin, User: whadmin, Pass: WhMkt2026!@AdamKorSim
- WooCommerce API keys already exist: see WOOCOMMERCE_API_KEYS_PRODUCTION.txt
- Gabia has extreme 24-48h server cache; use database/plugin approaches over file changes
- MU-plugins at /wp-content/mu-plugins/ auto-load without activation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy FTP files -- wp-config.php, .htaccess, headless-mode MU-plugin</name>
  <files>
    wp-config.php (modify via FTP - add JWT defines before "That's all" line)
    .htaccess (modify via FTP - add Authorization passthrough + CORS + cache bypass)
    wp-content/mu-plugins/headless-mode.php (create via FTP)
  </files>
  <action>
    1. **Download current wp-config.php** via FTP (ftplib, host=82mobile.com, port=21, user=adam82mob0105, pass=ssh82mobile2026!). Back up locally.

    2. **Add JWT defines to wp-config.php** before the "That's all, stop editing!" line:
       ```php
       define('JWT_AUTH_SECRET_KEY', '{generate-64-char-random-string}');
       define('JWT_AUTH_CORS_ENABLE', true);
       ```
       Generate the secret key using Python: `import secrets; secrets.token_urlsafe(48)`.
       Upload modified wp-config.php back via FTP.

    3. **Download current .htaccess** via FTP. Back up locally. Add the following BEFORE WordPress rewrite rules:
       ```apache
       # JWT Authorization header passthrough (required for Gabia shared hosting)
       <IfModule mod_rewrite.c>
         RewriteEngine On
         RewriteCond %{HTTP:Authorization} ^(.*)
         RewriteRule ^(.*) - [E=HTTP_AUTHORIZATION:%1]
       </IfModule>

       # CORS and cache bypass for API endpoints
       # NOTE: CoCart-API-Cart-Key header added in Plan 01-02 after CoCart install
       <IfModule mod_headers.c>
         <If "%{REQUEST_URI} =~ m#^/wp-json/#">
           Header set Access-Control-Allow-Origin "https://82mobile-next.vercel.app"
           Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
           Header set Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
           Header set Access-Control-Allow-Credentials "true"
           Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
           Header set Pragma "no-cache"
           Header set Expires "0"
         </If>
         SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
       </IfModule>
       ```
       Upload modified .htaccess via FTP.

    4. **Create headless-mode.php** MU-plugin:
       ```php
       <?php
       /*
        * Plugin Name: 82Mobile Headless Mode
        * Description: Disables WordPress frontend, preserves wp-admin and wp-json access
        */
       add_action('template_redirect', function() {
           if (is_admin()) return;
           if (strpos($_SERVER['REQUEST_URI'], '/wp-json/') === 0) return;
           if (strpos($_SERVER['REQUEST_URI'], '/wp-login.php') !== false) return;
           if (strpos($_SERVER['REQUEST_URI'], '/wp-admin') !== false) return;
           if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') return;

           status_header(404);
           echo 'This site is API-only. Visit wp-admin for administration.';
           exit;
       });
       ```
       Upload to /wp-content/mu-plugins/headless-mode.php via FTP.

    IMPORTANT: Do NOT include CoCart-API-Cart-Key in CORS headers yet -- CoCart is not installed until Plan 01-02, which will update .htaccess to add that header.
  </action>
  <verify>
    File-level verification (run immediately after FTP upload):

    1. wp-config.php deployed: `curl -s http://82mobile.com/wp-json/ | python3 -c "import sys,json; d=json.load(sys.stdin); print('API root OK')"` (confirms WordPress loads with new config without fatal error)
    2. JWT defines present: Download wp-config.php via FTP and grep for JWT_AUTH_SECRET_KEY -- must be present
    3. .htaccess deployed: `curl -s -I http://82mobile.com/wp-json/wp/v2/posts | grep -i "cache-control"` -- should contain no-cache
    4. MU-plugin deployed: `curl -s http://82mobile.com/wp-json/wp/v2/plugins?status=must-use` OR verify via FTP that /wp-content/mu-plugins/headless-mode.php exists and has non-zero size
    5. Headless mode active: `curl -s -o /dev/null -w "%{http_code}" http://82mobile.com/` should return 404
    6. Admin still works: `curl -s -o /dev/null -w "%{http_code}" http://82mobile.com/wp-admin/` should return 200 or 302
  </verify>
  <done>
    - wp-config.php contains JWT_AUTH_SECRET_KEY and JWT_AUTH_CORS_ENABLE defines
    - .htaccess has Authorization passthrough, CORS, and cache bypass rules
    - headless-mode.php MU-plugin exists and is loaded by WordPress
    - Homepage returns 404; /wp-admin and /wp-json/ remain accessible
  </done>
</task>

<task type="auto">
  <name>Task 2: Install JWT Authentication and Disable WP Frontend plugins via Playwright</name>
  <files>
    wp-content/plugins/jwt-authentication-for-wp-rest-api/ (via WP Admin)
    wp-content/plugins/developer-flavor-disable-wp-frontend/ (via WP Admin, optional)
  </files>
  <action>
    1. **Install JWT Authentication plugin** via Playwright browser automation:
       - Navigate to http://82mobile.com/wp-admin
       - Login with whadmin / WhMkt2026!@AdamKorSim
       - Go to Plugins > Add New
       - Search "JWT Authentication for WP REST API"
       - Install and activate
       - If already installed, just verify it's active

    2. **Install Disable WP Frontend plugin** (optional backup to MU-plugin):
       - Same Playwright flow: Plugins > Add New > search "Disable WP Frontend" > Install > Activate
       - Configure whitelist in Settings: /wp-admin/*, /wp-json/*, /wp-login.php

    IMPORTANT: Do NOT use functions.php for any configuration -- it's cached 24-48h on Gabia.
  </action>
  <verify>
    1. JWT plugin active: `curl -s -X POST http://82mobile.com/wp-json/jwt-auth/v1/token -H "Content-Type: application/json" -d '{"username":"whadmin","password":"WhMkt2026!@AdamKorSim"}'` returns JSON with "token" field
    2. JWT token validates: Use returned token in `curl -s http://82mobile.com/wp-json/jwt-auth/v1/token/validate -H "Authorization: Bearer {token}"` -- returns success
    3. CORS preflight: `curl -s -I -X OPTIONS http://82mobile.com/wp-json/wc/v3/products -H "Origin: https://82mobile-next.vercel.app" -H "Access-Control-Request-Method: GET"` includes Access-Control-Allow-Origin
    4. WooCommerce API: `curl -s "http://82mobile.com/wp-json/wc/v3/products" -u "CONSUMER_KEY:CONSUMER_SECRET"` returns products (get keys from WOOCOMMERCE_API_KEYS_PRODUCTION.txt)
  </verify>
  <done>
    - JWT Authentication plugin installed and activated; token endpoint functional
    - CORS OPTIONS preflight returns proper headers for Vercel domain
    - WooCommerce REST API returns product data with consumer key authentication
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>WordPress headless mode with JWT authentication, CORS, and cache bypass</what-built>
  <how-to-verify>
    1. Visit http://82mobile.com/ -- should show 404 or "API-only" message (NOT the old WordPress site)
    2. Visit http://82mobile.com/wp-admin/ -- should show WordPress admin login (still works)
    3. Visit http://82mobile.com/wp-json/wp/v2/posts -- should show JSON data
    4. Check that WP Admin > Plugins shows "JWT Authentication for WP REST API" as active
    5. Verify the customer's admin account still works (login as adam82mob0105 / tempadam2026!@)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
All verification checks from Tasks 1 and 2 must pass. If any fail due to Gabia caching, wait 1-2 hours and retry. If .htaccess changes don't take effect after 4 hours, fall back to plugin-based CORS and contact Gabia support about cache bypass.

NOTE: Cache bypass truth is verified by checking response headers (Cache-Control: no-cache). Full cache behavior validation (update product, query API, confirm fresh data) is deferred to Phase 2 integration testing where actual product updates occur.
</verification>

<success_criteria>
- WordPress public pages blocked (404), admin and API accessible
- JWT tokens generated and validated successfully
- CORS preflight from Vercel domain succeeds
- API cache bypass headers present in responses
- Requirements covered: BACKEND-01, BACKEND-02, BACKEND-03, BACKEND-04, BACKEND-06
</success_criteria>

<output>
After completion, create `.planning/phases/01-wordpress-backend-api-setup/01-01-SUMMARY.md`
</output>
