---
wave: 2
depends_on: [04-01]
files_modified:
  - app/api/orders/route.ts
  - components/cart/CartDrawerCheckout.tsx
  - lib/woocommerce.ts
autonomous: true
---

# Plan 04-02: WooCommerce Order Creation

## Objective

Complete `/api/orders` API route to create guest checkout orders in WooCommerce, and wire checkout form to call this API.

## Context

Plan 01 created the checkout form. Now we need to create actual WooCommerce orders when the form is submitted. The existing `/app/api/orders/route.ts` has basic structure but needs completion. WooCommerce REST API v3 supports guest checkout with `customer_id: 0`.

## Tasks

<task id="complete-orders-api">
<description>Complete /api/orders POST handler for guest checkout</description>

Replace `app/api/orders/route.ts` implementation:

```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { createOrder } from '@/lib/woocommerce';

/**
 * POST /api/orders
 * Create WooCommerce guest checkout order
 *
 * Request body:
 * - billing: { email, firstName, lastName, phone, address1?, city?, postcode?, country }
 * - items: [{ id: productId, quantity }]
 * - paymentMethod: 'portone' | 'eximbay'
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { billing, items, paymentMethod = 'portone' } = body;

    // Validate required fields
    if (!billing?.email || !billing?.firstName || !billing?.lastName || !billing?.phone) {
      return NextResponse.json(
        { error: 'Missing required billing fields' },
        { status: 400 }
      );
    }

    if (!items || items.length === 0) {
      return NextResponse.json(
        { error: 'Order must contain at least one item' },
        { status: 400 }
      );
    }

    // Create WooCommerce order
    const orderData = {
      customer_id: 0, // Guest checkout
      payment_method: paymentMethod,
      payment_method_title: paymentMethod === 'portone' ? 'Credit Card (PortOne)' : 'Credit Card (Eximbay)',
      billing: {
        first_name: billing.firstName,
        last_name: billing.lastName,
        email: billing.email,
        phone: billing.phone,
        address_1: billing.address1 || '',
        city: billing.city || '',
        postcode: billing.postcode || '',
        country: billing.country || 'KR'
      },
      line_items: items.map((item: { id: number; quantity: number }) => ({
        product_id: item.id,
        quantity: item.quantity
      })),
      status: 'pending', // Will be updated by payment webhook
      meta_data: [
        {
          key: '_order_source',
          value: '82mobile-next'
        },
        {
          key: '_created_via_api',
          value: 'true'
        }
      ]
    };

    const order = await createOrder(orderData);

    console.log(`[Orders API] Created WooCommerce order #${order.id} for ${billing.email}`);

    return NextResponse.json({
      success: true,
      orderId: order.id,
      orderNumber: order.number,
      total: order.total,
      currency: order.currency,
      status: order.status
    });
  } catch (error: any) {
    console.error('[Orders API] Error creating order:', error);

    return NextResponse.json(
      {
        error: 'Failed to create order',
        details: error.message || 'Unknown error'
      },
      { status: 500 }
    );
  }
}

/**
 * GET /api/orders?id={orderId}
 * Retrieve order details
 */
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const orderId = searchParams.get('id');

  if (!orderId) {
    return NextResponse.json(
      { error: 'Order ID required' },
      { status: 400 }
    );
  }

  try {
    // TODO: Implement getOrder() in lib/woocommerce.ts
    // const order = await getOrder(parseInt(orderId));

    return NextResponse.json({
      error: 'GET /api/orders not yet implemented'
    }, { status: 501 });
  } catch (error: any) {
    console.error('[Orders API] Error fetching order:', error);

    return NextResponse.json(
      { error: 'Failed to fetch order', details: error.message },
      { status: 500 }
    );
  }
}
```

Key decisions:
- `customer_id: 0` enables guest checkout (no WordPress user account required)
- `status: 'pending'` initially, payment webhook will update to 'processing' or 'completed'
- Meta data tracks order source for analytics
- Validation checks required billing fields before WooCommerce API call

Verification: TypeScript compilation passes
</task>

<task id="verify-woocommerce-lib">
<description>Verify createOrder exists in lib/woocommerce.ts</description>

Read `lib/woocommerce.ts` to confirm `createOrder()` function exists. If not, add it:

```typescript
export async function createOrder(orderData: any) {
  const response = await woocommerce.post('orders', orderData);
  return response.data;
}
```

The existing `lib/woocommerce.ts` should already have WooCommerce client initialization. This function wraps the orders endpoint.

Verification: `createOrder` function exported from lib/woocommerce.ts
</task>

<task id="wire-form-to-api">
<description>Wire checkout form to call /api/orders</description>

Update `components/cart/CartDrawerCheckout.tsx` to call the API:

```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { checkoutSchema, CheckoutFormData, defaultCheckoutValues } from '@/lib/validation/checkout-schema';
import { useCartStore } from '@/stores/cart';
import { useState } from 'react';
import { toast } from 'react-hot-toast'; // If using toast notifications

export default function CartDrawerCheckout() {
  const items = useCartStore((state) => state.items);
  const [orderError, setOrderError] = useState<string | null>(null);
  const [createdOrderId, setCreatedOrderId] = useState<number | null>(null);

  const total = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
  const tax = Math.round(total * 0.1);
  const grandTotal = total + tax;

  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting }
  } = useForm<CheckoutFormData>({
    resolver: zodResolver(checkoutSchema),
    mode: 'onBlur',
    reValidateMode: 'onChange',
    defaultValues: defaultCheckoutValues
  });

  const onSubmit = async (data: CheckoutFormData) => {
    setOrderError(null);

    try {
      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          billing: {
            email: data.email,
            firstName: data.firstName,
            lastName: data.lastName,
            phone: data.phone,
            address1: data.address1 || '',
            city: data.city || '',
            postcode: data.postcode || '',
            country: data.country
          },
          items: items.map(item => ({
            id: item.productId,
            quantity: item.quantity
          })),
          paymentMethod: 'portone'
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to create order');
      }

      const result = await response.json();

      console.log('Order created:', result);
      setCreatedOrderId(result.orderId);

      // TODO Phase 4 Plan 03: Initiate payment with PortOne
      alert(`Order #${result.orderId} created! Payment integration coming in Plan 03.`);
    } catch (error: any) {
      console.error('Order creation error:', error);
      setOrderError(error.message || 'Failed to create order. Please try again.');
    }
  };

  // Keep existing JSX, add error display after order summary
  return (
    <div className="flex flex-col h-full">
      {/* Order Summary */}
      <div className="p-4 bg-gray-50 rounded-lg mb-4">
        {/* ... existing order summary ... */}
      </div>

      {/* Error Display */}
      {orderError && (
        <div className="p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
          <p className="text-sm text-red-800">{orderError}</p>
        </div>
      )}

      {/* Success Display (temporary until payment integrated) */}
      {createdOrderId && (
        <div className="p-4 bg-green-50 border border-green-200 rounded-lg mb-4">
          <p className="text-sm text-green-800">
            Order #{createdOrderId} created successfully!
          </p>
        </div>
      )}

      {/* Existing form JSX */}
      <form onSubmit={handleSubmit(onSubmit)} className="flex-1 overflow-y-auto space-y-4">
        {/* ... existing fields ... */}
      </form>
    </div>
  );
}
```

Key changes:
- `useState` for order error and success tracking
- `fetch('/api/orders', { method: 'POST', ... })` on form submission
- Error handling with user-friendly messages
- Temporary success alert (Plan 03 will replace with payment flow)

Verification:
- Form submission calls `/api/orders` API
- Successful order creation shows alert with order ID
- API errors display in red error box
- Console logs order creation details
</task>

## Verification Criteria

**Functional:**
- [ ] Submitting checkout form creates WooCommerce order
- [ ] Order appears in WordPress admin under WooCommerce > Orders
- [ ] Order status is 'Pending Payment'
- [ ] Order contains correct line items from cart
- [ ] Order billing info matches form submission
- [ ] Guest checkout works (customer_id: 0)
- [ ] Error handling shows user-friendly messages

**Technical:**
- [ ] POST /api/orders returns { success: true, orderId: number }
- [ ] API validates required billing fields
- [ ] API validates items array not empty
- [ ] createOrder() function exists in lib/woocommerce.ts
- [ ] TypeScript compilation passes
- [ ] Console logs show order creation success

**UX:**
- [ ] Loading spinner shows during API call
- [ ] Success message displays with order ID
- [ ] Error messages display in red box
- [ ] Form stays disabled during submission

## Must-Haves (Phase Goal: Payment Submits)

- **Order created in WooCommerce**: POST /api/orders successfully creates order with status 'pending'
- **Guest checkout supported**: Orders created with customer_id: 0, no account required
- **Cart items transferred**: WooCommerce order line_items match cart contents

## Notes

- Plan 03 will add payment processing after order creation
- Order status starts as 'pending', payment webhook will update it
- Meta data tracks orders came from Next.js frontend for analytics
- GET /api/orders implementation deferred (not needed for Phase 4 goal)
