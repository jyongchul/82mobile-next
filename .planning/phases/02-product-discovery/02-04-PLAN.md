---
phase: 02-product-discovery
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - components/home/ProductExpanded.tsx
  - components/home/ProductsSection.tsx
  - lib/sanitize.ts
autonomous: true

must_haves:
  truths:
    - "Clicking product card shows expanded details without page navigation"
    - "Expanded view shows full description, features, and Add to Cart button"
    - "Product description HTML is properly sanitized before rendering"
    - "Clicking outside or close button dismisses expanded view"
    - "Expanded view has smooth enter/exit animation"
  artifacts:
    - path: "components/home/ProductExpanded.tsx"
      provides: "Expanded product details overlay/modal"
      exports: ["ProductExpanded"]
    - path: "lib/sanitize.ts"
      provides: "HTML sanitization utility"
      exports: ["sanitizeHtml"]
  key_links:
    - from: "components/home/ProductsSection.tsx"
      to: "components/home/ProductExpanded.tsx"
      via: "renders ProductExpanded when product selected"
      pattern: "<ProductExpanded"
    - from: "components/home/ProductExpanded.tsx"
      to: "stores/cart.ts"
      via: "useCartStore for add to cart"
      pattern: "useCartStore"
    - from: "components/home/ProductExpanded.tsx"
      to: "lib/sanitize.ts"
      via: "sanitizeHtml for description"
      pattern: "sanitizeHtml"
---

<objective>
Implement inline product expansion that shows full product details without navigating away from the single-page flow.

Purpose: Users should be able to view complete product information without losing their place on the page, maintaining the single-page experience.
Output: ProductExpanded overlay component triggered by clicking product cards, with sanitized HTML rendering.
</objective>

<execution_context>
@/home/charles_lee/.claude/get-shit-done/workflows/execute-plan.md
@/home/charles_lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@components/home/ProductsSection.tsx (from Plan 01/03)
@components/shop/ProductCard.tsx
@stores/cart.ts
@hooks/useToast.ts (from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install DOMPurify and create sanitize utility</name>
  <files>lib/sanitize.ts</files>
  <action>
First, install DOMPurify for safe HTML rendering:
```bash
cd /mnt/c/82Mobile/82mobile-next && npm install dompurify && npm install -D @types/dompurify
```

Then create a sanitization utility (lib/sanitize.ts):

```typescript
import DOMPurify from 'dompurify';

/**
 * Sanitize HTML content to prevent XSS attacks
 * Used for WooCommerce product descriptions which contain HTML
 */
export function sanitizeHtml(dirty: string): string {
  // Configure DOMPurify to allow safe HTML tags
  return DOMPurify.sanitize(dirty, {
    ALLOWED_TAGS: [
      'p', 'br', 'strong', 'b', 'em', 'i', 'u', 's',
      'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
      'ul', 'ol', 'li',
      'a', 'span', 'div',
      'table', 'thead', 'tbody', 'tr', 'th', 'td',
    ],
    ALLOWED_ATTR: ['href', 'target', 'rel', 'class'],
    // Force all links to open in new tab with noopener
    ALLOW_DATA_ATTR: false,
    ADD_ATTR: ['target', 'rel'],
  });
}
```

This ensures WooCommerce product descriptions are safely rendered without XSS risk.
  </action>
  <verify>
1. Package installed: `cd /mnt/c/82Mobile/82mobile-next && npm ls dompurify`
2. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>DOMPurify installed and sanitize utility created</done>
</task>

<task type="auto">
  <name>Task 2: Create ProductExpanded overlay component</name>
  <files>components/home/ProductExpanded.tsx</files>
  <action>
Create an expanded product view overlay with full details:

```typescript
'use client';

import { useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import Image from 'next/image';
import { useCartStore } from '@/stores/cart';
import { useToast } from '@/hooks/useToast';
import { sanitizeHtml } from '@/lib/sanitize';
import type { Product } from '@/hooks/useProducts';

interface ProductExpandedProps {
  product: Product | null;
  onClose: () => void;
}

export default function ProductExpanded({ product, onClose }: ProductExpandedProps) {
  const addItem = useCartStore((state) => state.addItem);
  const { toast } = useToast();

  // Close on Escape key
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };
    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [onClose]);

  // Prevent body scroll when open
  useEffect(() => {
    if (product) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => {
      document.body.style.overflow = '';
    };
  }, [product]);

  const handleAddToCart = () => {
    if (!product) return;

    addItem({
      productId: product.id,
      name: product.name,
      slug: product.slug,
      price: parseFloat(product.price.replace(/,/g, '')),
      image: product.image,
    }, 1);

    toast(`${product.name} added to cart!`, 'success');
    onClose();
  };

  return (
    <AnimatePresence>
      {product && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50"
          />

          {/* Modal */}
          <motion.div
            initial={{ opacity: 0, scale: 0.95, y: 20 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95, y: 20 }}
            transition={{ type: 'spring', duration: 0.5 }}
            className="fixed inset-4 md:inset-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-3xl md:max-h-[90vh] bg-white rounded-2xl shadow-2xl z-50 overflow-hidden flex flex-col"
          >
            {/* Close Button */}
            <button
              onClick={onClose}
              className="absolute top-4 right-4 z-10 w-10 h-10 bg-white/90 rounded-full flex items-center justify-center text-gray-600 hover:text-gray-900 hover:bg-white transition-colors shadow-lg"
              aria-label="Close"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>

            {/* Scrollable Content */}
            <div className="overflow-y-auto flex-1">
              {/* Product Image */}
              <div className="relative h-64 md:h-80 bg-gray-100">
                <Image
                  src={product.image}
                  alt={product.name}
                  fill
                  className="object-cover"
                  priority
                />

                {/* Badges */}
                <div className="absolute top-4 left-4 flex gap-2">
                  {product.duration && (
                    <span className="bg-dancheong-red text-white px-3 py-1 rounded-full text-sm font-bold shadow-lg">
                      {product.duration}
                    </span>
                  )}
                  {product.dataAmount && (
                    <span className="bg-hanbok-blue text-white px-3 py-1 rounded-full text-sm font-bold shadow-lg">
                      {product.dataAmount}
                    </span>
                  )}
                </div>
              </div>

              {/* Product Details */}
              <div className="p-6 md:p-8">
                <h2 className="font-display text-2xl md:text-3xl font-bold text-gray-900 mb-2">
                  {product.name}
                </h2>

                <div className="flex items-baseline gap-3 mb-6">
                  <span className="text-3xl md:text-4xl font-bold text-dancheong-red">
                    â‚©{product.price}
                  </span>
                  {product.regularPrice && product.regularPrice !== product.price && (
                    <span className="text-xl text-gray-400 line-through">
                      â‚©{product.regularPrice}
                    </span>
                  )}
                </div>

                {/* Description - SANITIZED HTML */}
                {product.description && (
                  <div
                    className="prose prose-gray max-w-none mb-6"
                    dangerouslySetInnerHTML={{
                      __html: sanitizeHtml(product.description)
                    }}
                  />
                )}

                {/* Features Grid */}
                <div className="grid grid-cols-2 gap-4 mb-6">
                  {[
                    { icon: 'âš¡', label: 'Instant Activation' },
                    { icon: 'ðŸ“¶', label: 'High-Speed 5G/LTE' },
                    { icon: 'ðŸŒ', label: 'Nationwide Coverage' },
                    { icon: 'ðŸ’¬', label: '24/7 Support' },
                  ].map((feature, index) => (
                    <div
                      key={index}
                      className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg"
                    >
                      <span className="text-2xl">{feature.icon}</span>
                      <span className="text-sm font-medium text-gray-700">{feature.label}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Sticky Footer */}
            <div className="sticky bottom-0 p-4 bg-white border-t border-gray-100 flex gap-4">
              <button
                onClick={onClose}
                className="flex-1 py-3 px-4 border-2 border-gray-300 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition-colors"
              >
                Continue Browsing
              </button>
              <button
                onClick={handleAddToCart}
                className="flex-1 py-3 px-4 bg-dancheong-red text-white font-bold rounded-xl hover:bg-red-700 transition-colors flex items-center justify-center gap-2"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Add to Cart
              </button>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  );
}
```

Key features:
- Full-screen on mobile, centered modal on desktop
- Image with badges (duration, data amount)
- Product description rendered with DOMPurify sanitization
- Features grid with icons
- Sticky footer with CTA buttons
- Escape key and backdrop click to close
- Body scroll lock when open
- Spring animation for entry/exit
  </action>
  <verify>TypeScript compiles: `cd /mnt/c/82Mobile/82mobile-next && npx tsc --noEmit`</verify>
  <done>ProductExpanded overlay component created with sanitized HTML</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ProductExpanded with ProductsSection</name>
  <files>components/home/ProductsSection.tsx</files>
  <action>
Update ProductsSection to track selected product and show ProductExpanded:

1. Add state for selected product:
```typescript
const [selectedProduct, setSelectedProduct] = useState<Product | null>(null);
```

2. Import ProductExpanded:
```typescript
import ProductExpanded from './ProductExpanded';
```

3. Make ProductCard clickable to select product (wrap in div with onClick):
```typescript
<div
  key={product.id}
  onClick={() => setSelectedProduct(product)}
  className="cursor-pointer"
>
  <ProductCard
    // ... existing props
  />
</div>
```

4. Render ProductExpanded at the end of the component:
```typescript
<ProductExpanded
  product={selectedProduct}
  onClose={() => setSelectedProduct(null)}
/>
```

Full updated return section:
```typescript
return (
  <>
    <ProductFilter onFilterChange={handleFilterChange} initialFilters={filters} />

    {filteredProducts.length === 0 ? (
      <div className="text-center py-12">
        <p className="text-gray-500 text-lg">No products match your filters</p>
        <button
          onClick={() => setFilters({ type: 'all', duration: 'all' })}
          className="mt-4 text-hanbok-blue hover:underline font-medium"
        >
          Clear filters
        </button>
      </div>
    ) : (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {filteredProducts.map((product) => (
          <div
            key={product.id}
            onClick={() => setSelectedProduct(product)}
            className="cursor-pointer"
          >
            <ProductCard
              id={product.id}
              slug={product.slug}
              name={product.name}
              price={product.price}
              regularPrice={product.regularPrice}
              image={product.image}
              duration={product.duration}
              dataAmount={product.dataAmount}
            />
          </div>
        ))}
      </div>
    )}

    <ProductExpanded
      product={selectedProduct}
      onClose={() => setSelectedProduct(null)}
    />
  </>
);
```

Note: ProductCard has its own Link wrapper. The click on the wrapper div will be captured by React's event bubbling. If needed, update ProductCard.tsx to:
- Accept an `onClick` prop and use it instead of Link when provided, OR
- Add `e.preventDefault(); e.stopPropagation();` to the parent div click handler

For cleaner approach, add this to the wrapper div:
```typescript
onClick={(e) => {
  e.preventDefault();
  setSelectedProduct(product);
}}
```

This prevents the default Link navigation and triggers the modal instead.
  </action>
  <verify>
1. Run dev server: `cd /mnt/c/82Mobile/82mobile-next && npm run dev`
2. Open http://localhost:3000 and scroll to Products section
3. Click a product card - verify expanded overlay appears
4. Verify animation is smooth (scale + fade)
5. Click backdrop or X button - verify overlay closes
6. Press Escape - verify overlay closes
7. Click "Add to Cart" in overlay - verify toast appears and overlay closes
  </verify>
  <done>Clicking product shows inline expanded details without page navigation</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. DOMPurify installed and used for HTML sanitization
3. Product click opens expanded overlay (not new page)
4. Overlay shows product image, name, price, sanitized description
5. Add to Cart button works from overlay
6. Close button (X) dismisses overlay
7. Backdrop click dismisses overlay
8. Escape key dismisses overlay
9. Body scroll is locked when overlay open
10. Animation is smooth (spring transition)
</verification>

<success_criteria>
- No page navigation when viewing product details
- Product description HTML is sanitized via DOMPurify
- Overlay is fully accessible (escape key, focus trap)
- Mobile: full-screen; Desktop: centered modal
- User can add to cart directly from expanded view
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-discovery/02-04-SUMMARY.md`
</output>
