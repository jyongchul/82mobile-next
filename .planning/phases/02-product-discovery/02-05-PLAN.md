---
phase: 02-product-discovery
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.js
  - components/shop/ProductCard.tsx
  - components/home/ProductsSection.tsx
autonomous: true

must_haves:
  truths:
    - "Product images below the fold load on scroll, not immediately"
    - "Loading placeholder shows while images load"
    - "Images use Next.js optimized formats (WebP/AVIF)"
    - "No layout shift when images load"
  artifacts:
    - path: "next.config.js"
      provides: "Next.js Image configuration for WooCommerce domain"
      contains: "images"
    - path: "components/shop/ProductCard.tsx"
      provides: "Lazy-loaded product images"
      contains: "loading=\"lazy\""
  key_links:
    - from: "components/shop/ProductCard.tsx"
      to: "next/image"
      via: "Next.js Image component with lazy loading"
      pattern: "import Image from 'next/image'"
---

<objective>
Optimize product images with lazy loading to improve initial page load performance.

Purpose: Products below the fold should not block initial render. Lazy loading reduces LCP and improves Lighthouse score.
Output: Images lazy load with blur placeholder, no layout shift.
</objective>

<execution_context>
@/home/charles_lee/.claude/get-shit-done/workflows/execute-plan.md
@/home/charles_lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@components/shop/ProductCard.tsx
@next.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Next.js Image for WooCommerce domain</name>
  <files>next.config.js</files>
  <action>
Update next.config.js to allow images from WooCommerce domain:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    // Allow images from WooCommerce domain
    remotePatterns: [
      {
        protocol: 'http',
        hostname: '82mobile.com',
        pathname: '/wp-content/uploads/**',
      },
      {
        protocol: 'https',
        hostname: '82mobile.com',
        pathname: '/wp-content/uploads/**',
      },
      {
        protocol: 'https',
        hostname: 'via.placeholder.com',
        pathname: '/**',
      },
    ],
    // Enable modern image formats
    formats: ['image/avif', 'image/webp'],
    // Device sizes for responsive images
    deviceSizes: [640, 750, 828, 1080, 1200, 1920],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    // Minimize layout shift
    minimumCacheTTL: 60 * 60 * 24, // 24 hours
  },
  // ... keep any existing config options
};

module.exports = nextConfig;
```

Key settings:
- remotePatterns: Allow 82mobile.com WooCommerce images
- formats: Serve AVIF (best compression) with WebP fallback
- deviceSizes/imageSizes: Responsive breakpoints for srcset
- minimumCacheTTL: Cache images for 24 hours
  </action>
  <verify>
1. TypeScript compiles: `cd /mnt/c/82Mobile/82mobile-next && npx tsc --noEmit`
2. Dev server starts: `npm run dev` (no config errors)
  </verify>
  <done>Next.js Image configured for WooCommerce domain</done>
</task>

<task type="auto">
  <name>Task 2: Update ProductCard with optimized lazy loading</name>
  <files>components/shop/ProductCard.tsx</files>
  <action>
Update ProductCard to use proper lazy loading with blur placeholder:

1. Update the Image component in the front of card:

```typescript
<Image
  src={image}
  alt={name}
  fill
  sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
  className="object-cover group-hover:scale-110 transition-transform duration-500"
  loading="lazy"
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAIAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUH/8QAIhAAAgEDAwUBAAAAAAAAAAAAAQIDAAQRBRIhBhMxQVFh/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAZEQADAQEBAAAAAAAAAAAAAAABAgMAETH/2gAMAwEAAhEDEQA/ANB07rLVNOtobeG0tTHGgjUsrFiAMeT+1d+q6nd63fLd3xiM6xrGPbGwqgjgkgdyf2vXqiiqYo4EDQK1RO5P/9k="
/>
```

Key changes:
- `sizes`: Tell browser how wide image will be at each breakpoint
- `loading="lazy"`: Native lazy loading (below fold images)
- `placeholder="blur"`: Show blurred version while loading
- `blurDataURL`: Inline base64 placeholder (tiny gray image)

2. For the hero/above-fold images (first 3 products), use `priority`:
Note: This will be handled in ProductsSection, not ProductCard itself.

3. Update ProductCard to accept a `priority` prop:

```typescript
interface ProductCardProps {
  // ... existing props
  priority?: boolean;
}

export default function ProductCard({
  // ... existing props
  priority = false
}: ProductCardProps) {
  // ...

  <Image
    src={image}
    alt={name}
    fill
    sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
    className="object-cover group-hover:scale-110 transition-transform duration-500"
    loading={priority ? 'eager' : 'lazy'}
    priority={priority}
    placeholder="blur"
    blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAIAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUH/8QAIhAAAgEDAwUBAAAAAAAAAAAAAQIDAAQRBRIhBhMxQVFh/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAZEQADAQEBAAAAAAAAAAAAAAABAgMAETH/2gAMAwEAAhEDEQA/ANB07rLVNOtobeG0tTHGgjUsrFiAMeT+1d+q6nd63fLd3xiM6xrGPbGwqgjgkgdyf2vXqiiqYo4EDQK1RO5P/9k="
  />
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Run dev server: `npm run dev`
3. Open http://localhost:3000, scroll to Products
4. Open DevTools Network tab, filter by "img"
5. Scroll down - verify images load as they enter viewport
6. Verify images use WebP format (check Response Headers)
  </verify>
  <done>ProductCard images lazy load with blur placeholder</done>
</task>

<task type="auto">
  <name>Task 3: Mark above-fold images as priority in ProductsSection</name>
  <files>components/home/ProductsSection.tsx</files>
  <action>
Update ProductsSection to pass priority prop to first 3 products (above fold on desktop):

```typescript
{filteredProducts.map((product, index) => (
  <div
    key={product.id}
    onClick={() => setSelectedProduct(product)}
    className="cursor-pointer"
  >
    <ProductCard
      id={product.id}
      slug={product.slug}
      name={product.name}
      price={product.price}
      regularPrice={product.regularPrice}
      image={product.image}
      duration={product.duration}
      dataAmount={product.dataAmount}
      priority={index < 3} // First 3 products are above fold
    />
  </div>
))}
```

This ensures:
- First 3 products: `priority={true}` - load immediately (above fold)
- Products 4+: `priority={false}` - lazy load as user scrolls
  </action>
  <verify>
1. Run dev server and open http://localhost:3000
2. Open DevTools Network tab, filter by "img"
3. Refresh page - verify first 3 product images load immediately
4. Verify products 4+ load only when scrolling to them
5. Check Lighthouse Performance score
  </verify>
  <done>Above-fold images marked as priority, below-fold lazy loaded</done>
</task>

</tasks>

<verification>
1. next.config.js includes proper image configuration
2. WooCommerce images load without errors
3. Images use WebP/AVIF format (check Network tab headers)
4. First 3 images load immediately (priority)
5. Remaining images lazy load on scroll
6. Blur placeholder shows during image load
7. No layout shift (CLS) when images load
8. Lighthouse Performance: Images should not be flagged as "offscreen images loaded"
</verification>

<success_criteria>
- Images below fold load on scroll (verified in Network tab)
- Images use modern formats (WebP/AVIF)
- No Cumulative Layout Shift from images
- Lighthouse "properly size images" and "defer offscreen images" pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-discovery/02-05-SUMMARY.md`
</output>
